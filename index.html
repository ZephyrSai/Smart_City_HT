<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart City Digital Twin</title>
    <style>
        :root {
            --bg: #edf2f7;
            --panel: #ffffff;
            --panel-border: #d7e0ea;
            --text: #1a2736;
            --muted: #5f6f80;
            --accent: #1876c8;
            --danger: #d84a4a;
            --left-rail-w: 214px;
            --right-panel-w: 390px;
            --topbar-h: 58px;
            --modebar-h: 52px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: "Segoe UI", Arial, sans-serif;
        }

        .app {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: radial-gradient(circle at 24% 10%, #263445 0%, #101a24 55%, #0b141d 100%);
        }

        .left {
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        .topbar {
            position: absolute;
            top: 14px;
            left: 14px;
            right: 14px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
            border: 1px solid rgba(206, 224, 244, 0.42);
            border-radius: 14px;
            background: rgba(14, 28, 43, 0.42);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 8px 10px;
            overflow: hidden;
            min-height: 54px;
        }

        .topbar-head {
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 32px;
        }

        .topbar-content {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }

        .topbar-main-groups {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
        }

        .topbar-meta-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: wrap;
            gap: 8px;
            width: 100%;
            align-content: flex-start;
        }

        .top-group {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            border: 1px solid rgba(200, 219, 241, 0.3);
            border-radius: 10px;
            background: rgba(194, 214, 238, 0.08);
            padding: 4px 6px;
            min-height: 34px;
            max-width: 100%;
        }

        .top-group.meta {
            width: 100%;
            justify-content: flex-end;
        }

        .group-label {
            font-size: 11px;
            letter-spacing: 0.04em;
            font-weight: 700;
            color: #c9ddef;
            text-transform: uppercase;
        }

        .topbar.collapsed {
            min-height: 42px;
            padding: 6px 10px;
        }

        .topbar.collapsed .topbar-content,
        .topbar.collapsed #boot-error {
            display: none;
        }

        .chip {
            font-size: 12px;
            color: #e5eef8;
            border: 1px solid rgba(201, 219, 241, 0.38);
            background: rgba(201, 219, 241, 0.14);
            border-radius: 999px;
            padding: 6px 10px;
        }

        .btn {
            border: 1px solid rgba(197, 216, 238, 0.52);
            background: rgba(198, 221, 246, 0.14);
            color: #e9f3ff;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn[disabled] {
            opacity: 0.45;
            cursor: default;
        }

        .btn.primary {
            border-color: #6db8ff;
            background: rgba(31, 128, 214, 0.92);
            color: #fff;
        }

        .btn.toggle-on {
            border-color: #7fd8b2;
            background: rgba(35, 148, 111, 0.88);
            color: #f5fffb;
        }

        #status {
            margin-left: auto;
            font-size: 12px;
            color: #d0deed;
            white-space: nowrap;
            flex: 1 1 180px;
            text-align: right;
            min-width: 120px;
        }

        #boot-error {
            display: none;
            border: 1px solid rgba(239, 194, 194, 0.9);
            border-radius: 8px;
            background: rgba(255, 235, 235, 0.92);
            color: #9f3232;
            font-size: 12px;
            padding: 8px 10px;
        }

        .mode-switcher {
            position: absolute;
            top: calc(14px + var(--topbar-h) + 14px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 96;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(203, 220, 242, 0.44);
            border-radius: 999px;
            background: rgba(10, 24, 37, 0.56);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 7px 10px;
            max-width: calc(100% - 28px);
        }

        .mode-btn {
            border: 1px solid rgba(198, 220, 244, 0.52);
            border-radius: 999px;
            background: rgba(198, 221, 246, 0.15);
            color: #eef7ff;
            font-size: 13px;
            font-weight: 700;
            padding: 8px 14px;
            cursor: pointer;
            transition: background 140ms ease, border-color 140ms ease, transform 140ms ease;
            white-space: nowrap;
        }

        .mode-btn:hover {
            transform: translateY(-1px);
        }

        .mode-switcher.mode-city #btn-enter-detail {
            border-color: #ffc36c;
            background: linear-gradient(160deg, #e28b16, #bb5f00);
            color: #fff;
        }

        .mode-switcher.mode-city #btn-city-view {
            border-color: #6dc8ff;
            background: linear-gradient(160deg, #248ad8, #176eb4);
            color: #fff;
        }

        .mode-switcher.mode-detail #btn-back {
            border-color: #ffb6a8;
            background: linear-gradient(160deg, #ca5240, #94382a);
            color: #fff;
        }

        .mode-btn[disabled] {
            opacity: 0.48;
            cursor: default;
        }

        #view-stack {
            position: absolute;
            inset: 0;
            border-radius: 0;
            overflow: hidden;
            border: 0;
            background: #0f1b26;
        }

        .view-pane {
            position: absolute;
            inset: 0;
            transition: opacity 420ms ease, transform 420ms ease;
        }

        #world-pane {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        #detail-pane {
            opacity: 0;
            transform: scale(1.02);
            pointer-events: none;
        }

        #view-stack.detail-mode #world-pane {
            opacity: 0;
            transform: scale(0.985);
            pointer-events: none;
        }

        #view-stack.detail-mode #detail-pane {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .view-host {
            width: 100%;
            height: 100%;
        }

        .tag {
            position: absolute;
            top: calc(14px + var(--topbar-h) + var(--modebar-h) + 10px);
            left: calc(14px + var(--left-rail-w));
            z-index: 20;
            border: 1px solid rgba(204, 216, 228, 0.55);
            border-radius: 8px;
            background: rgba(15, 29, 44, 0.5);
            padding: 6px 10px;
            font-size: 12px;
            color: #e7f0fb;
        }

        .attribution {
            position: absolute;
            left: calc(14px + var(--left-rail-w));
            bottom: 14px;
            z-index: 20;
            border: 1px solid rgba(204, 216, 228, 0.55);
            border-radius: 8px;
            background: rgba(15, 29, 44, 0.5);
            padding: 6px 10px;
            font-size: 11px;
            color: #e7f0fb;
        }

        .attribution a {
            color: #75bdff;
            text-decoration: none;
        }

        .alert-rail {
            position: absolute;
            left: 14px;
            top: calc(14px + var(--topbar-h) + var(--modebar-h) + 10px);
            bottom: 14px;
            width: var(--left-rail-w);
            z-index: 30;
            border-radius: 12px;
            border: 1px solid rgba(204, 224, 246, 0.42);
            background: rgba(14, 31, 45, 0.34);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            color: #f5f9ff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .alert-rail-head {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 10px 8px;
            border-bottom: 1px solid rgba(211, 228, 244, 0.24);
            font-size: 11px;
            letter-spacing: 0.08em;
            font-weight: 800;
            color: #eff7ff;
            background: rgba(173, 201, 231, 0.08);
        }

        .alert-rail-list {
            list-style: none;
            margin: 0;
            padding: 8px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        .alert-rail-item {
            border-radius: 8px;
            border: 1px solid rgba(202, 222, 243, 0.32);
            background: rgba(234, 245, 255, 0.09);
            padding: 7px;
            color: #f6fbff;
            font-size: 11px;
            line-height: 1.35;
        }

        .alert-rail-item.critical {
            border-color: rgba(255, 149, 149, 0.62);
            background: rgba(165, 40, 40, 0.26);
        }

        .alert-rail-item.watch {
            border-color: rgba(255, 217, 153, 0.52);
            background: rgba(145, 96, 28, 0.2);
        }

        .alert-rail-badge {
            display: inline-flex;
            border-radius: 999px;
            padding: 3px 6px;
            margin-right: 5px;
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 0.03em;
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .alert-rail-item.watch .alert-rail-badge {
            background: rgba(255, 193, 89, 0.35);
        }

        .alert-rail-item.critical .alert-rail-badge {
            background: rgba(255, 124, 124, 0.42);
        }

        .right {
            position: absolute;
            right: 14px;
            top: calc(14px + var(--topbar-h) + var(--modebar-h) + 10px);
            bottom: 14px;
            width: var(--right-panel-w);
            z-index: 70;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 2px;
        }

        .right-resizer {
            position: absolute;
            left: -6px;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            z-index: 85;
        }

        .left-resizer {
            position: absolute;
            right: -6px;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            z-index: 85;
        }

        .panel-collapse-btn {
            border: 1px solid rgba(197, 216, 238, 0.52);
            background: rgba(198, 221, 246, 0.14);
            color: #e9f3ff;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            margin-left: auto;
        }

        .side-tab {
            position: absolute;
            z-index: 95;
            border: 1px solid rgba(197, 216, 238, 0.56);
            background: rgba(16, 33, 50, 0.65);
            color: #edf6ff;
            border-radius: 10px;
            padding: 7px 10px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            white-space: nowrap;
            max-width: 180px;
        }

        .side-tab.left {
            left: 14px;
            top: calc(14px + var(--topbar-h) + var(--modebar-h) + 10px);
        }

        .side-tab.right {
            right: 14px;
            top: calc(14px + var(--topbar-h) + var(--modebar-h) + 10px);
        }

        .app.left-collapsed .side-tab.left,
        .app.right-collapsed .side-tab.right {
            display: inline-flex;
        }

        .app.phone-mode .alert-rail,
        .app.phone-mode .side-tab,
        .app.phone-mode .right-resizer,
        .app.phone-mode .left-resizer {
            display: none !important;
        }

        .app.phone-mode .topbar {
            left: 10px;
            right: 10px;
            padding: 8px;
        }

        .app.phone-mode .mode-switcher {
            top: calc(10px + var(--topbar-h) + 10px);
            width: auto;
            padding: 6px 8px;
            gap: 7px;
        }

        .app.phone-mode .mode-btn {
            font-size: 12px;
            padding: 7px 11px;
        }

        .app.phone-mode .right {
            left: 10px;
            right: 10px;
            width: auto;
            top: auto;
            bottom: 10px;
            max-height: 42%;
            gap: 8px;
            padding: 0;
            z-index: 80;
        }

        .app.phone-mode .card {
            padding: 10px;
        }

        .app.phone-mode #user-card,
        .app.phone-mode #district-card,
        .app.phone-mode .panel-tabs,
        .app.phone-mode #alerts-pane {
            display: none !important;
        }

        .app.phone-mode #btn-right-collapse,
        .app.phone-mode #btn-left-collapse {
            display: none !important;
        }

        .app.phone-mode #kpi-card .title {
            font-size: 16px;
        }

        .app.phone-mode #kpi-card .muted {
            display: none;
        }

        .app.phone-mode .kpi-grid {
            margin-top: 4px;
            gap: 6px;
        }

        .app.phone-mode .kpi .v {
            font-size: 22px;
        }

        .app.phone-mode #dashboard-pane {
            gap: 8px;
        }

        .app.phone-mode #selected-card .meta .v {
            font-size: 14px;
        }

        .card {
            background: rgba(208, 223, 241, 0.16);
            border: 1px solid rgba(208, 223, 241, 0.35);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 12px;
            padding: 12px;
            color: #eaf3ff;
        }

        .title {
            margin: 0 0 6px;
            font-size: 18px;
            font-weight: 700;
        }

        .muted {
            color: #cae0f7;
            font-size: 12px;
        }

        .kpi-grid {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .kpi {
            border: 1px solid rgba(222, 232, 242, 0.38);
            border-radius: 8px;
            background: rgba(242, 248, 255, 0.2);
            padding: 8px;
        }

        .kpi .k {
            font-size: 11px;
            color: #cae0f7;
        }

        .kpi .v {
            margin-top: 4px;
            font-size: 30px;
            line-height: 1;
            font-weight: 700;
        }

        .bar-row {
            margin-top: 8px;
        }

        .bar-head {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .bar-track {
            width: 100%;
            height: 9px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(219, 232, 247, 0.25);
        }

        .bar-fill {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #49b7f8, #1976c8);
            transition: width 260ms ease;
        }

        .meta-grid {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 7px;
        }

        .meta {
            border: 1px solid rgba(222, 232, 241, 0.35);
            border-radius: 8px;
            background: rgba(248, 251, 254, 0.2);
            padding: 7px;
        }

        .meta .k {
            font-size: 11px;
            color: #cae0f7;
        }

        .meta .v {
            margin-top: 3px;
            font-size: 15px;
            font-weight: 700;
        }

        #alert-list {
            margin: 8px 0 0;
            padding-left: 18px;
            font-size: 12px;
            line-height: 1.4;
            max-height: 180px;
            overflow: auto;
        }

        #alert-list li {
            margin: 5px 0;
        }

        .stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .panel-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 2px;
        }

        .panel-tab {
            border: 1px solid rgba(200, 217, 237, 0.45);
            background: rgba(169, 196, 224, 0.18);
            color: #dbeaf9;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .panel-tab.active {
            background: rgba(22, 115, 195, 0.9);
            color: #fff;
            border-color: #71bdff;
        }

        .pane-hidden {
            display: none;
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            border: 1px solid rgba(211, 230, 248, 0.52);
            background: linear-gradient(135deg, #208be5, #165388);
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .role-select {
            width: 100%;
            margin-top: 8px;
            border-radius: 8px;
            border: 1px solid rgba(202, 219, 237, 0.45);
            background: rgba(238, 247, 255, 0.2);
            color: #eef6ff;
            padding: 7px 8px;
            font-size: 12px;
        }

        .perm-list {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .perm {
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid rgba(170, 210, 173, 0.45);
            color: #d8f2d7;
            background: rgba(42, 122, 61, 0.26);
        }

        .perm.denied {
            border-color: rgba(225, 153, 153, 0.5);
            color: #ffd3d3;
            background: rgba(148, 43, 43, 0.3);
        }

        .alert-contrast {
            border-color: rgba(255, 102, 102, 0.65);
            background: linear-gradient(160deg, rgba(67, 15, 20, 0.92), rgba(98, 28, 25, 0.88));
        }

        .alert-kpis {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .alert-kpi {
            border: 1px solid rgba(255, 145, 145, 0.5);
            border-radius: 8px;
            background: rgba(255, 118, 118, 0.14);
            padding: 8px;
        }

        .alert-kpi .k {
            font-size: 11px;
            color: #ffd0d0;
        }

        .alert-kpi .v {
            margin-top: 4px;
            font-size: 24px;
            font-weight: 700;
            color: #fff0f0;
        }

        #alert-list-contrast {
            margin: 10px 0 0;
            padding-left: 0;
            list-style: none;
            max-height: 320px;
            overflow: auto;
            font-size: 12px;
        }

        .alert-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px;
            align-items: start;
            padding: 8px;
            margin-bottom: 7px;
            border-radius: 8px;
            border: 1px solid rgba(255, 138, 138, 0.45);
            background: rgba(255, 99, 99, 0.12);
        }

        .alert-item.watch {
            border-color: rgba(255, 213, 128, 0.45);
            background: rgba(255, 182, 67, 0.14);
        }

        .alert-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 62px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 800;
            line-height: 1;
            padding: 5px 7px;
            color: #ffefef;
            background: #d33d3d;
        }

        .alert-badge.watch {
            color: #fff4dc;
            background: #b97019;
        }

        .alert-text {
            color: #ffecec;
        }

        .detail-popup {
            position: absolute;
            left: 18px;
            top: 18px;
            z-index: 90;
            width: min(320px, calc(100% - 36px));
            border-radius: 12px;
            border: 1px solid rgba(197, 217, 238, 0.45);
            background: rgba(12, 29, 44, 0.86);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #e9f2fc;
            padding: 10px;
            display: none;
            transform-origin: 18px 20px;
            animation: bubbleIn 180ms ease;
        }

        .detail-popup.visible {
            display: block;
        }

        .detail-popup::after {
            content: "";
            position: absolute;
            left: var(--tail-x, 18px);
            top: calc(100% - 3px);
            width: 12px;
            height: 12px;
            transform: rotate(45deg);
            border-right: 1px solid rgba(197, 217, 238, 0.45);
            border-bottom: 1px solid rgba(197, 217, 238, 0.45);
            background: rgba(12, 29, 44, 0.86);
        }

        @keyframes bubbleIn {
            0% {
                opacity: 0;
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .detail-popup-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .detail-popup-title {
            font-size: 14px;
            font-weight: 700;
        }

        .detail-popup-close {
            border: 1px solid rgba(200, 220, 242, 0.5);
            background: rgba(200, 220, 242, 0.12);
            color: #f2f8ff;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .detail-popup-body {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            font-size: 12px;
        }

        .popup-cell {
            border: 1px solid rgba(217, 231, 244, 0.32);
            border-radius: 8px;
            background: rgba(231, 242, 252, 0.14);
            padding: 6px;
        }

        .center-modal {
            position: absolute;
            inset: 0;
            z-index: 120;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(7, 16, 27, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .center-modal.visible {
            display: flex;
        }

        .center-modal-card {
            width: min(460px, calc(100% - 28px));
            border: 1px solid rgba(198, 217, 239, 0.52);
            border-radius: 14px;
            background: rgba(18, 34, 50, 0.9);
            box-shadow: 0 18px 40px rgba(4, 10, 18, 0.45);
            padding: 14px;
            color: #ecf6ff;
        }

        .center-modal-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
        }

        .center-modal-hint {
            margin-top: 6px;
            font-size: 12px;
            color: #c8def4;
        }

        .center-modal-input {
            width: 100%;
            margin-top: 10px;
            border: 1px solid rgba(191, 213, 236, 0.48);
            border-radius: 9px;
            background: rgba(223, 240, 255, 0.12);
            color: #f3f9ff;
            padding: 10px;
            font-size: 13px;
        }

        .center-modal-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .login-modal {
            position: fixed;
            inset: 0;
            z-index: 210;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(6, 15, 25, 0.68);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .login-modal.visible {
            display: flex;
        }

        .login-card {
            width: min(420px, calc(100% - 28px));
            border: 1px solid rgba(198, 220, 244, 0.52);
            border-radius: 14px;
            background: rgba(17, 33, 49, 0.92);
            box-shadow: 0 20px 42px rgba(1, 7, 12, 0.55);
            padding: 14px;
            color: #eef7ff;
        }

        .login-title {
            margin: 0;
            font-size: 18px;
            font-weight: 800;
        }

        .login-hint {
            margin-top: 6px;
            font-size: 12px;
            color: #c8def4;
        }

        .login-row {
            margin-top: 10px;
        }

        .login-label {
            display: block;
            font-size: 12px;
            color: #cfe1f5;
            margin-bottom: 4px;
        }

        .login-input {
            width: 100%;
            border: 1px solid rgba(194, 216, 239, 0.46);
            border-radius: 9px;
            background: rgba(233, 245, 255, 0.12);
            color: #f3f9ff;
            padding: 9px 10px;
            font-size: 13px;
        }

        .login-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .login-error {
            margin-top: 8px;
            min-height: 18px;
            font-size: 12px;
            color: #ffbcbc;
        }

        @media (max-width: 1160px) {
            .topbar {
                gap: 7px;
            }
            .chip {
                font-size: 11px;
                padding: 6px 8px;
            }
            .btn {
                font-size: 11px;
            }
            #status {
                font-size: 11px;
            }
        }

        @media (max-width: 760px) {
            .topbar-head {
                flex-wrap: wrap;
            }
            #status {
                flex: 1 1 100%;
                text-align: left;
            }
            .top-group {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            .top-group.meta {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <section class="left">
            <div class="topbar">
                <div class="topbar-head">
                    <button class="btn" id="btn-topbar-toggle">Collapse Top Bar</button>
                    <span class="chip">Digital Twin: map texture integrated in 3D world</span>
                    <span id="status">Loading map tiles...</span>
                </div>
                <div class="topbar-content">
                    <div class="topbar-main-groups">
                        <div class="top-group">
                            <span class="group-label">Map</span>
                            <button class="btn" id="btn-style">Map Style</button>
                            <button class="btn" id="btn-center">Set Map Center</button>
                            <button class="btn" id="btn-import-asset">Import Asset</button>
                        </div>
                        <div class="top-group">
                            <span class="group-label">Layout</span>
                            <button class="btn" id="btn-road-draw">Road Path: Off</button>
                            <button class="btn" id="btn-edit-layout">Edit Layout: Off</button>
                            <button class="btn toggle-on" id="btn-routes">Routes: On</button>
                        </div>
                        <div class="top-group">
                            <span class="group-label">Session</span>
                            <button class="btn" id="btn-user">User Settings</button>
                        </div>
                    </div>
                    <div class="topbar-meta-row">
                        <div class="top-group meta">
                            <span class="chip" id="map-meta-chip">Style: Carto Dark Â· Zoom 16</span>
                            <span class="chip" id="center-chip">Center: 40.7128, -74.0060</span>
                            <span class="chip" id="road-chip">Road Draw: Off</span>
                        </div>
                    </div>
                </div>
                <div id="boot-error"></div>
            </div>
            <div class="mode-switcher mode-city" id="mode-switcher">
                <button class="mode-btn" id="btn-city-view">3D City View</button>
                <button class="mode-btn" id="btn-enter-detail" disabled>Enter Building View</button>
                <button class="mode-btn" id="btn-back" style="display:none;">Back To 3D World</button>
            </div>

            <aside class="alert-rail" id="left-alert-rail">
                <div class="alert-rail-head">
                    <span>LIVE ALERT FEED</span>
                    <button class="panel-collapse-btn" id="btn-left-collapse">Hide Alerts</button>
                </div>
                <ul class="alert-rail-list" id="left-alert-list"></ul>
                <div class="left-resizer" id="left-resizer"></div>
            </aside>

            <div id="view-stack">
                <div id="world-pane" class="view-pane">
                    <div class="tag">3D World (Basemap + buildings)</div>
                    <div id="world-host" class="view-host"></div>
                    <div class="attribution" id="attribution"></div>
                </div>
                <div id="detail-pane" class="view-pane">
                    <div class="tag">Building Detail View</div>
                    <div id="detail-host" class="view-host"></div>
                    <div class="detail-popup" id="detail-popup">
                        <div class="detail-popup-head">
                            <div class="detail-popup-title" id="detail-popup-title">Building</div>
                            <button class="detail-popup-close" id="detail-popup-close">Close</button>
                        </div>
                        <div class="detail-popup-body" id="detail-popup-body"></div>
                    </div>
                </div>
            </div>
        </section>

        <aside class="right" id="right-panel">
            <div class="right-resizer" id="right-resizer"></div>
            <section class="card" id="user-card">
                <div class="user-row">
                    <div class="avatar">SC</div>
                    <div>
                        <div class="title" style="font-size:16px; margin:0;" id="user-name">John Doe</div>
                        <div class="muted" id="role-caption">Role: Operator</div>
                    </div>
                    <button class="panel-collapse-btn" id="btn-right-collapse">Hide Dashboard</button>
                </div>
                <select class="role-select" id="role-select">
                    <option value="Viewer">Viewer</option>
                    <option value="Operator" selected>Operator</option>
                    <option value="Admin">Admin</option>
                </select>
                <button class="btn" id="btn-logout" style="margin-top:8px;">Log Out</button>
                <div class="perm-list" id="perm-list"></div>
            </section>

            <section class="card" id="kpi-card">
                <h1 class="title">Smart City Digital Twin</h1>
                <div class="muted">Click a building in the city to transition into building-only mode.</div>
                <div class="kpi-grid">
                    <div class="kpi"><div class="k">Buildings</div><div class="v" id="kpi-buildings">0</div></div>
                    <div class="kpi"><div class="k">Grid Load (MW)</div><div class="v" id="kpi-load">0</div></div>
                    <div class="kpi"><div class="k">Avg Occupancy</div><div class="v" id="kpi-occupancy">0%</div></div>
                    <div class="kpi"><div class="k">Active Alerts</div><div class="v" id="kpi-alerts">0</div></div>
                </div>
            </section>

            <div class="panel-tabs">
                <button class="panel-tab active" id="tab-dashboard">Dashboard</button>
                <button class="panel-tab" id="tab-alerts">Alerts</button>
            </div>

            <div id="dashboard-pane" class="stack">
                <section class="card" id="district-card">
                    <h2 class="title" style="font-size:16px;">District Utilization</h2>
                    <div id="district-bars"></div>
                </section>

                <section class="card" id="selected-card">
                    <h2 class="title" style="font-size:16px;">Selected Building</h2>
                    <div class="muted" id="selected-name">No building selected</div>
                    <div class="meta-grid">
                        <div class="meta"><div class="k">District</div><div class="v" id="meta-district">-</div></div>
                        <div class="meta"><div class="k">Type</div><div class="v" id="meta-type">-</div></div>
                        <div class="meta"><div class="k">Energy</div><div class="v" id="meta-energy">-</div></div>
                        <div class="meta"><div class="k">Occupancy</div><div class="v" id="meta-occupancy">-</div></div>
                    </div>
                </section>

                <section class="card" style="flex:1; min-height:170px; display:none;">
                    <h2 class="title" style="font-size:16px;">Priority Alerts</h2>
                    <ul id="alert-list"></ul>
                </section>
            </div>

            <div id="alerts-pane" class="stack pane-hidden">
                <section class="card alert-contrast" style="flex:1; min-height:300px;">
                    <h2 class="title" style="font-size:18px;">Alerts Console</h2>
                    <div class="muted">High-contrast event stream with severity tags.</div>
                    <div class="alert-kpis">
                        <div class="alert-kpi"><div class="k">Critical</div><div class="v" id="alert-critical-count">0</div></div>
                        <div class="alert-kpi"><div class="k">Watch</div><div class="v" id="alert-watch-count">0</div></div>
                    </div>
                    <ul id="alert-list-contrast"></ul>
                </section>
            </div>
        </aside>
        <button class="side-tab left" id="btn-left-show">Show Alerts</button>
        <button class="side-tab right" id="btn-right-show">Show Dashboard</button>
    </div>

    <div class="center-modal" id="center-modal">
        <div class="center-modal-card" role="dialog" aria-modal="true" aria-labelledby="center-modal-title">
            <h3 class="center-modal-title" id="center-modal-title">Set Base Map Center</h3>
            <div class="center-modal-hint">Paste `latitude,longitude` or `latitude longitude` and click Apply.</div>
            <input id="center-input" class="center-modal-input" type="text" spellcheck="false" autocomplete="off" />
            <div class="center-modal-actions">
                <button class="btn" id="btn-center-cancel">Cancel</button>
                <button class="btn primary" id="btn-center-apply">Apply Center</button>
            </div>
        </div>
    </div>

    <div class="login-modal" id="login-modal">
        <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
            <h3 class="login-title" id="login-title">Smart City Login</h3>
            <div class="login-hint">Demo credentials: <b>admin / admin</b></div>
            <div class="login-row">
                <label class="login-label" for="login-username">Username</label>
                <input id="login-username" class="login-input" type="text" autocomplete="username" />
            </div>
            <div class="login-row">
                <label class="login-label" for="login-password">Password</label>
                <input id="login-password" class="login-input" type="password" autocomplete="current-password" />
            </div>
            <div class="login-actions">
                <button class="btn primary" id="btn-login">Login</button>
            </div>
            <div class="login-error" id="login-error"></div>
        </div>
    </div>

    <script src="ht.js"></script>
    <script>
        (function () {
            var app = {
                center: { lat: 40.7128, lng: -74.0060 },
                baseZoom: 16,
                zoom: 16,
                minZoom: 15,
                maxZoom: 18,
                baseTileSpan: 6,
                minTileSpan: 3,
                tileSpan: 6,
                maxTileSpan: 12,
                tileSize: 256,
                baseUnitsPerPixel: 3.1,
                unitsPerPixel: 3.1,
                mapTextureName: "osm.floor.texture",
                currentMapStyle: "cartoDark",
                mapStyles: {
                    cartoDark: {
                        name: "Carto Dark",
                        url: "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png",
                        subdomains: ["a", "b", "c", "d"],
                        retina: true,
                        tint: "rgba(0, 0, 0, 0)",
                        attribution: 'Map tiles &copy; <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a>, data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap contributors</a>'
                    },
                    cartoDarkLabels: {
                        name: "Carto Dark Labels",
                        url: "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
                        subdomains: ["a", "b", "c", "d"],
                        retina: true,
                        tint: "rgba(0, 0, 0, 0)",
                        attribution: 'Map tiles &copy; <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a>, data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap contributors</a>'
                    },
                    osm: {
                        name: "OpenStreetMap",
                        url: "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                        subdomains: [],
                        retina: false,
                        tint: "rgba(7, 12, 18, 0.2)",
                        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap contributors</a>'
                    },
                    cartoLight: {
                        name: "Carto Light",
                        url: "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
                        subdomains: ["a", "b", "c", "d"],
                        retina: true,
                        tint: "rgba(23, 41, 58, 0.04)",
                        attribution: 'Map tiles &copy; <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a>, data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap contributors</a>'
                    },
                    cartoVoyager: {
                        name: "Carto Voyager",
                        url: "https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png",
                        subdomains: ["a", "b", "c", "d"],
                        retina: true,
                        tint: "rgba(8, 13, 19, 0.16)",
                        attribution: 'Map tiles &copy; <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a>, data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap contributors</a>'
                    }
                },

                worldDM: null,
                world3d: null,
                detailDM: null,
                detail3d: null,

                floorNode: null,
                detailFloor: null,
                detailBuildingNode: null,
                routeNodes: [],
                junctionRoadNodes: [],
                customRoadNodes: [],
                draftRoadNodes: [],

                buildings: [],
                byId: {},
                junctions: [],
                junctionById: {},
                importedAssets: [],
                assetCounter: 0,
                customRoadPaths: [],
                customRoadCounter: 0,
                roadDrawMode: false,
                drawingRoadPoints: [],
                selectedId: null,
                detailOpen: false,
                telemetryTimer: null,
                suppressSelectionTransition: false,
                animateBuildingHeights: false,
                editMode: false,
                routesVisible: true,
                editSyncTimer: null,
                routeRebuildTimer: null,

                mapMeta: null,
                districtBarEls: {},
                tileStats: { ok: 0, fail: 0 },
                activeZoom: 16,
                mapLoading: false,
                pendingZoom: null,
                pendingForce: false,
                mapReloadToken: 0,
                zoomMonitorTimer: null,
                mapTextureScale: 1,
                zoomCandidate: null,
                zoomCandidateCount: 0,
                detailPopupAnchor: null,
                authStorageKey: "smart_city_demo_auth_v1",
                appStarted: false,
                cameraMinDistance: 980,
                cameraMaxDistance: 3550,
                cameraCenterMargin: 80,
                leftRailWidth: 214,
                rightPanelWidth: 390,
                collapsedRailGutter: 0,
                leftPanelCollapsed: false,
                rightPanelCollapsed: false,
                topbarCollapsed: false,
                activeResize: null,
                resizeMoveHandler: null,
                resizeUpHandler: null,
                topbarResizeObserver: null,

                currentRole: "Operator",
                rolePermissions: {
                    Viewer: {
                        enterBuilding: false,
                        styleSwitch: false,
                        detailPopup: true,
                        alertConsole: false,
                        editLayout: false
                    },
                    Operator: {
                        enterBuilding: true,
                        styleSwitch: true,
                        detailPopup: true,
                        alertConsole: true,
                        editLayout: true
                    },
                    Admin: {
                        enterBuilding: true,
                        styleSwitch: true,
                        detailPopup: true,
                        alertConsole: true,
                        editLayout: true
                    }
                },

                init: function () {
                    this.cacheDom();
                    this.bindButtons();
                    if (!this.restoreAuthSession()) {
                        this.showLoginModal();
                        return;
                    }
                    this.hideLoginModal();
                    this.startApp();
                },

                startApp: function () {
                    if (this.appStarted) return;
                    this.appStarted = true;
                    this.initLayoutControls();
                    if (!window.ht || !window.ht.graph3d || !window.ht.graph3d.Graph3dView) {
                        this.showBootError("HT Graph3dView runtime not available.");
                        return;
                    }

                    this.initWorld3d();
                    this.initDetail3d();
                    this.bindDetailInteraction();
                    this.buildDistrictBars();
                    this.bindResize();
                    this.updateAttribution();
                    this.updateMapMetaChip();
                    this.updateCenterChip();
                    this.updateRoadDrawUi();
                    this.applyRole(this.currentRole);
                    this.openPanelTab("dashboard");
                    this.updateModeSwitcher();

                    this.reloadMapForZoom(this.zoom, true).then(function () {
                        app.activeZoom = app.zoom;
                        app.createBuildings(48);
                        app.createRoadJunctions(18);
                        app.rebuildNetworks();
                        app.bindWorldSelection();
                        app.bindWorldInteraction();
                        app.startZoomMonitor();
                        app.updateDashboard();
                        app.startTelemetry();
                        app.world3d.invalidate();
                    }).catch(function (err) {
                        app.showBootError(err && err.message ? err.message : String(err));
                        app.status.textContent = "Map texture failed";
                    });
                },

                cacheDom: function () {
                    this.appRoot = document.querySelector(".app");
                    this.topbar = document.querySelector(".topbar");
                    this.modeSwitcher = document.getElementById("mode-switcher");
                    this.rightPanel = document.getElementById("right-panel");
                    this.leftAlertRail = document.getElementById("left-alert-rail");
                    this.userName = document.getElementById("user-name");
                    this.userAvatar = document.querySelector(".avatar");
                    this.btnTopbarToggle = document.getElementById("btn-topbar-toggle");
                    this.btnLeftCollapse = document.getElementById("btn-left-collapse");
                    this.btnRightCollapse = document.getElementById("btn-right-collapse");
                    this.btnLeftShow = document.getElementById("btn-left-show");
                    this.btnRightShow = document.getElementById("btn-right-show");
                    this.leftResizer = document.getElementById("left-resizer");
                    this.rightResizer = document.getElementById("right-resizer");
                    this.viewStack = document.getElementById("view-stack");
                    this.detailHost = document.getElementById("detail-host");
                    this.btnCity = document.getElementById("btn-city-view");
                    this.btnStyle = document.getElementById("btn-style");
                    this.btnCenter = document.getElementById("btn-center");
                    this.btnImport = document.getElementById("btn-import-asset");
                    this.btnRoadDraw = document.getElementById("btn-road-draw");
                    this.btnEdit = document.getElementById("btn-edit-layout");
                    this.btnRoutes = document.getElementById("btn-routes");
                    this.btnEnter = document.getElementById("btn-enter-detail");
                    this.btnBack = document.getElementById("btn-back");
                    this.btnUser = document.getElementById("btn-user");
                    this.mapMetaChip = document.getElementById("map-meta-chip");
                    this.centerChip = document.getElementById("center-chip");
                    this.roadChip = document.getElementById("road-chip");
                    this.status = document.getElementById("status");
                    this.bootError = document.getElementById("boot-error");
                    this.attribution = document.getElementById("attribution");
                    this.roleSelect = document.getElementById("role-select");
                    this.roleCaption = document.getElementById("role-caption");
                    this.permList = document.getElementById("perm-list");
                    this.tabDashboard = document.getElementById("tab-dashboard");
                    this.tabAlerts = document.getElementById("tab-alerts");
                    this.dashboardPane = document.getElementById("dashboard-pane");
                    this.alertsPane = document.getElementById("alerts-pane");
                    this.alertListContrast = document.getElementById("alert-list-contrast");
                    this.leftAlertList = document.getElementById("left-alert-list");
                    this.alertCriticalCount = document.getElementById("alert-critical-count");
                    this.alertWatchCount = document.getElementById("alert-watch-count");
                    this.detailPopup = document.getElementById("detail-popup");
                    this.detailPopupTitle = document.getElementById("detail-popup-title");
                    this.detailPopupBody = document.getElementById("detail-popup-body");
                    this.detailPopupClose = document.getElementById("detail-popup-close");
                    this.centerModal = document.getElementById("center-modal");
                    this.centerInput = document.getElementById("center-input");
                    this.btnCenterApply = document.getElementById("btn-center-apply");
                    this.btnCenterCancel = document.getElementById("btn-center-cancel");
                    this.btnLogout = document.getElementById("btn-logout");
                    this.loginModal = document.getElementById("login-modal");
                    this.loginUsername = document.getElementById("login-username");
                    this.loginPassword = document.getElementById("login-password");
                    this.loginError = document.getElementById("login-error");
                    this.btnLogin = document.getElementById("btn-login");

                    this.kpiBuildings = document.getElementById("kpi-buildings");
                    this.kpiLoad = document.getElementById("kpi-load");
                    this.kpiOccupancy = document.getElementById("kpi-occupancy");
                    this.kpiAlerts = document.getElementById("kpi-alerts");

                    this.selectedName = document.getElementById("selected-name");
                    this.metaDistrict = document.getElementById("meta-district");
                    this.metaType = document.getElementById("meta-type");
                    this.metaEnergy = document.getElementById("meta-energy");
                    this.metaOccupancy = document.getElementById("meta-occupancy");

                    this.alertList = document.getElementById("alert-list");
                    this.districtBars = document.getElementById("district-bars");
                },

                bindButtons: function () {
                    var self = this;
                    this.btnCity.addEventListener("click", function () {
                        self.closeDetailView();
                    });
                    this.btnStyle.addEventListener("click", function () {
                        self.cycleMapStyle();
                    });
                    this.btnCenter.addEventListener("click", function () {
                        self.promptMapCenter();
                    });
                    this.btnImport.addEventListener("click", function () {
                        self.promptImportAsset();
                    });
                    this.btnRoadDraw.addEventListener("click", function () {
                        self.toggleRoadDrawMode();
                    });
                    this.btnTopbarToggle.addEventListener("click", function () {
                        self.setTopbarCollapsed(!self.topbarCollapsed);
                    });
                    this.btnLeftCollapse.addEventListener("click", function () {
                        self.setLeftPanelCollapsed(true);
                    });
                    this.btnRightCollapse.addEventListener("click", function () {
                        self.setRightPanelCollapsed(true);
                    });
                    this.btnLeftShow.addEventListener("click", function () {
                        self.setLeftPanelCollapsed(false);
                    });
                    this.btnRightShow.addEventListener("click", function () {
                        self.setRightPanelCollapsed(false);
                    });
                    this.leftResizer.addEventListener("mousedown", function (e) {
                        self.startSidebarResize("left", e);
                    });
                    this.rightResizer.addEventListener("mousedown", function (e) {
                        self.startSidebarResize("right", e);
                    });
                    this.btnEdit.addEventListener("click", function () {
                        self.setEditMode(!self.editMode);
                    });
                    this.btnRoutes.addEventListener("click", function () {
                        self.toggleRoutes();
                    });
                    this.btnEnter.addEventListener("click", function () {
                        if (self.selectedId) {
                            self.openDetailView(self.selectedId);
                        }
                    });
                    this.btnBack.addEventListener("click", function () {
                        self.closeDetailView();
                    });
                    this.btnUser.addEventListener("click", function () {
                        self.openPanelTab("dashboard");
                        if (self.roleSelect) self.roleSelect.focus();
                    });
                    this.tabDashboard.addEventListener("click", function () {
                        self.openPanelTab("dashboard");
                    });
                    this.tabAlerts.addEventListener("click", function () {
                        self.openPanelTab("alerts");
                    });
                    this.roleSelect.addEventListener("change", function () {
                        self.applyRole(self.roleSelect.value);
                    });
                    this.detailPopupClose.addEventListener("click", function () {
                        self.hideDetailPopup();
                    });
                    this.btnCenterApply.addEventListener("click", function () {
                        self.applyCenterFromInput();
                    });
                    this.btnCenterCancel.addEventListener("click", function () {
                        self.closeCenterModal();
                    });
                    if (this.btnLogout) {
                        this.btnLogout.addEventListener("click", function () {
                            self.logout();
                        });
                    }
                    if (this.btnLogin) {
                        this.btnLogin.addEventListener("click", function () {
                            self.attemptLogin();
                        });
                    }
                    if (this.loginPassword) {
                        this.loginPassword.addEventListener("keydown", function (e) {
                            if (e.key === "Enter") self.attemptLogin();
                        });
                    }
                    if (this.loginUsername) {
                        this.loginUsername.addEventListener("keydown", function (e) {
                            if (e.key === "Enter") self.attemptLogin();
                        });
                    }
                    this.centerInput.addEventListener("keydown", function (e) {
                        if (e.key === "Enter") {
                            self.applyCenterFromInput();
                        }
                        else if (e.key === "Escape") {
                            self.closeCenterModal();
                        }
                    });
                    this.centerModal.addEventListener("click", function (e) {
                        if (e.target === self.centerModal) {
                            self.closeCenterModal();
                        }
                    });
                },

                initLayoutControls: function () {
                    var self = this;
                    if (window.ResizeObserver && this.topbar) {
                        this.topbarResizeObserver = new ResizeObserver(function () {
                            self.applyLayout();
                        });
                        this.topbarResizeObserver.observe(this.topbar);
                    }
                    this.applyLayout();
                },

                setTopbarCollapsed: function (collapsed) {
                    this.topbarCollapsed = !!collapsed;
                    this.applyLayout();
                },

                setLeftPanelCollapsed: function (collapsed) {
                    this.leftPanelCollapsed = !!collapsed;
                    this.applyLayout();
                },

                setRightPanelCollapsed: function (collapsed) {
                    this.rightPanelCollapsed = !!collapsed;
                    this.applyLayout();
                },

                startSidebarResize: function (side, e) {
                    if (!e || e.button !== 0) return;
                    if (side === "left" && this.leftPanelCollapsed) return;
                    if (side === "right" && this.rightPanelCollapsed) return;
                    e.preventDefault();
                    var self = this;
                    this.activeResize = {
                        side: side,
                        startX: e.clientX,
                        leftWidth: this.leftRailWidth,
                        rightWidth: this.rightPanelWidth
                    };
                    this.resizeMoveHandler = function (ev) {
                        self.onSidebarResizeMove(ev);
                    };
                    this.resizeUpHandler = function () {
                        self.stopSidebarResize();
                    };
                    document.body.style.cursor = "ew-resize";
                    document.addEventListener("mousemove", this.resizeMoveHandler);
                    document.addEventListener("mouseup", this.resizeUpHandler);
                },

                onSidebarResizeMove: function (e) {
                    if (!this.activeResize) return;
                    var dx = e.clientX - this.activeResize.startX;
                    if (this.activeResize.side === "left") {
                        this.leftRailWidth = this.clamp(Math.round(this.activeResize.leftWidth + dx), 160, 420);
                        this.leftPanelCollapsed = false;
                    }
                    else {
                        this.rightPanelWidth = this.clamp(Math.round(this.activeResize.rightWidth - dx), 280, 620);
                        this.rightPanelCollapsed = false;
                    }
                    this.applyLayout();
                },

                stopSidebarResize: function () {
                    this.activeResize = null;
                    if (this.resizeMoveHandler) {
                        document.removeEventListener("mousemove", this.resizeMoveHandler);
                        this.resizeMoveHandler = null;
                    }
                    if (this.resizeUpHandler) {
                        document.removeEventListener("mouseup", this.resizeUpHandler);
                        this.resizeUpHandler = null;
                    }
                    document.body.style.cursor = "";
                },

                applyLayout: function () {
                    var phone = window.innerWidth <= 760;
                    var compact = phone;
                    var leftW = compact ? 0 : (this.leftPanelCollapsed ? this.collapsedRailGutter : this.leftRailWidth);
                    var rightW = compact ? 0 : (this.rightPanelCollapsed ? this.collapsedRailGutter : this.rightPanelWidth);
                    document.documentElement.style.setProperty("--left-rail-w", leftW + "px");
                    document.documentElement.style.setProperty("--right-panel-w", rightW + "px");

                    if (this.topbar) {
                        this.topbar.classList.toggle("collapsed", this.topbarCollapsed);
                    }
                    if (this.btnTopbarToggle) {
                        this.btnTopbarToggle.textContent = this.topbarCollapsed ? "Expand Top Bar" : "Collapse Top Bar";
                    }
                    if (this.leftAlertRail) {
                        this.leftAlertRail.style.display = (!compact && !this.leftPanelCollapsed) ? "flex" : "none";
                    }
                    if (this.rightPanel) {
                        var showRightPanel = phone || (!compact && !this.rightPanelCollapsed);
                        this.rightPanel.style.display = showRightPanel ? "flex" : "none";
                    }
                    if (this.appRoot) {
                        this.appRoot.classList.toggle("phone-mode", phone);
                        this.appRoot.classList.toggle("left-collapsed", !compact && this.leftPanelCollapsed);
                        this.appRoot.classList.toggle("right-collapsed", !compact && this.rightPanelCollapsed && !phone);
                    }
                    if (this.btnLeftShow) {
                        this.btnLeftShow.style.display = (!compact && this.leftPanelCollapsed) ? "inline-flex" : "none";
                    }
                    if (this.btnRightShow) {
                        this.btnRightShow.style.display = (!compact && this.rightPanelCollapsed && !phone) ? "inline-flex" : "none";
                    }
                    if (phone && this.dashboardPane && this.dashboardPane.classList.contains("pane-hidden")) {
                        this.openPanelTab("dashboard");
                    }

                    var h = this.topbar ? this.topbar.offsetHeight : 54;
                    document.documentElement.style.setProperty("--topbar-h", (h || 54) + "px");
                    var modeH = this.modeSwitcher ? (this.modeSwitcher.offsetHeight || 44) + 14 : 0;
                    document.documentElement.style.setProperty("--modebar-h", modeH + "px");
                    this.updateModeSwitcher();
                    if (this.world3d) this.world3d.invalidate();
                    if (this.detail3d) this.detail3d.invalidate();
                },

                updateModeSwitcher: function () {
                    if (!this.modeSwitcher) return;
                    this.modeSwitcher.classList.toggle("mode-detail", !!this.detailOpen);
                    this.modeSwitcher.classList.toggle("mode-city", !this.detailOpen);
                    if (this.btnCity) {
                        this.btnCity.setAttribute("aria-pressed", this.detailOpen ? "false" : "true");
                    }
                },

                showLoginModal: function () {
                    if (!this.loginModal) return;
                    this.loginModal.classList.add("visible");
                    if (this.loginUsername) {
                        this.loginUsername.value = "";
                    }
                    if (this.loginPassword) {
                        this.loginPassword.value = "";
                    }
                    if (this.loginError) {
                        this.loginError.textContent = "";
                    }
                    var self = this;
                    setTimeout(function () {
                        if (self.loginUsername) self.loginUsername.focus();
                    }, 20);
                },

                hideLoginModal: function () {
                    if (!this.loginModal) return;
                    this.loginModal.classList.remove("visible");
                },

                restoreAuthSession: function () {
                    var raw = null;
                    try {
                        raw = window.localStorage.getItem(this.authStorageKey);
                    }
                    catch (ignore) {
                    }
                    if (!raw) return false;
                    var data = null;
                    try {
                        data = JSON.parse(raw);
                    }
                    catch (ignore2) {
                        return false;
                    }
                    if (!data || data.username !== "admin" || data.password !== "admin") return false;
                    this.applySessionUser({ username: "admin", role: "Admin" });
                    return true;
                },

                persistAuthSession: function (username, password) {
                    try {
                        window.localStorage.setItem(this.authStorageKey, JSON.stringify({
                            username: username,
                            password: password,
                            role: "Admin"
                        }));
                    }
                    catch (ignore) {
                    }
                },

                clearAuthSession: function () {
                    try {
                        window.localStorage.removeItem(this.authStorageKey);
                    }
                    catch (ignore) {
                    }
                },

                applySessionUser: function (user) {
                    var username = user && user.username ? user.username : "admin";
                    var role = user && user.role ? user.role : "Admin";
                    if (this.userName) {
                        this.userName.textContent = username;
                    }
                    if (this.userAvatar) {
                        this.userAvatar.textContent = username.slice(0, 2).toUpperCase();
                    }
                    if (this.roleSelect) {
                        this.roleSelect.value = role;
                    }
                    this.currentRole = role;
                },

                attemptLogin: function () {
                    var username = this.loginUsername ? this.loginUsername.value.trim().toLowerCase() : "";
                    var password = this.loginPassword ? this.loginPassword.value.trim() : "";
                    if (username !== "admin" || password !== "admin") {
                        if (this.loginError) this.loginError.textContent = "Invalid credentials. Use admin/admin.";
                        return;
                    }
                    this.applySessionUser({ username: "admin", role: "Admin" });
                    this.persistAuthSession("admin", "admin");
                    this.hideLoginModal();
                    this.startApp();
                },

                logout: function () {
                    this.clearAuthSession();
                    window.location.reload();
                },

                openPanelTab: function (tab) {
                    var showAlerts = tab === "alerts";
                    this.tabDashboard.classList.toggle("active", !showAlerts);
                    this.tabAlerts.classList.toggle("active", showAlerts);
                    this.dashboardPane.classList.toggle("pane-hidden", showAlerts);
                    this.alertsPane.classList.toggle("pane-hidden", !showAlerts);
                },

                applyRole: function (role) {
                    this.currentRole = role;
                    var perms = this.rolePermissions[role] || this.rolePermissions.Operator;
                    this.roleCaption.textContent = "Role: " + role;
                    this.renderPermissions(perms);
                    this.btnStyle.disabled = !perms.styleSwitch;
                    this.btnImport.disabled = !perms.editLayout;
                    this.btnRoadDraw.disabled = !perms.editLayout;
                    this.btnEdit.disabled = !perms.editLayout;
                    this.btnEnter.disabled = this.editMode || this.roadDrawMode || !this.selectedId || !perms.enterBuilding;
                    if (!perms.editLayout && this.editMode) {
                        this.setEditMode(false);
                    }
                    if (!perms.editLayout && this.roadDrawMode) {
                        this.setRoadDrawMode(false, true);
                    }
                    if (!perms.enterBuilding && this.detailOpen) {
                        this.closeDetailView();
                    }
                    if (!perms.alertConsole) {
                        this.openPanelTab("dashboard");
                        this.tabAlerts.disabled = true;
                    }
                    else {
                        this.tabAlerts.disabled = false;
                    }
                    this.updateModeSwitcher();
                },

                renderPermissions: function (perms) {
                    if (!this.permList) return;
                    var labels = [
                        ["Enter Building", perms.enterBuilding],
                        ["Switch Map Style", perms.styleSwitch],
                        ["Edit Layout", perms.editLayout],
                        ["Detail Popup", perms.detailPopup],
                        ["Alert Console", perms.alertConsole]
                    ];
                    this.permList.innerHTML = "";
                    for (var i = 0; i < labels.length; i++) {
                        var p = document.createElement("span");
                        p.className = "perm" + (labels[i][1] ? "" : " denied");
                        p.textContent = labels[i][0];
                        this.permList.appendChild(p);
                    }
                },

                bindResize: function () {
                    var self = this;
                    window.addEventListener("resize", function () {
                        self.applyLayout();
                        self.world3d.invalidate();
                        self.detail3d.invalidate();
                    }, false);
                },

                showBootError: function (message) {
                    this.bootError.style.display = "block";
                    this.bootError.textContent = "Startup Error: " + message;
                },

                initWorld3d: function () {
                    this.worldDM = new ht.DataModel();
                    this.world3d = new ht.graph3d.Graph3dView(this.worldDM);

                    var worldView = this.world3d.getView();
                    worldView.style.background = "#1d2936";
                    worldView.style.position = "absolute";
                    worldView.style.left = "0";
                    worldView.style.top = "0";
                    worldView.style.width = "100%";
                    worldView.style.height = "100%";
                    this.world3d.setGridVisible(false);
                    this.world3d.setOriginAxisVisible(false);
                    this.world3d.setCenterAxisVisible(false);
                    this.world3d.setEye([0, 1650, 1800]);
                    this.world3d.setCenter([0, 120, 0]);
                    this.world3d.setEditable(false);
                    var self = this;
                    this.world3d.setMovableFunc(function (data) {
                        if (!(self.editMode && data && data.a)) return false;
                        var kind = data.a("kind");
                        return kind === "building" || kind === "junction" || kind === "importedAsset";
                    });

                    var host = document.getElementById("world-host");
                    host.appendChild(worldView);

                    this.floorNode = new ht.Node();
                    this.floorNode.p3([0, -2, 0]);
                    this.floorNode.s3([3000, 4, 3000]);
                    this.floorNode.s({
                        "shape3d": "rect",
                        "shape3d.color": "#1e2a35",
                        "shape3d.top.color": "#2a3b4d",
                        "shape3d.top.visible": true,
                        "shape3d.light": false
                    });
                    this.floorNode.a("kind", "ground");
                    this.worldDM.add(this.floorNode);
                },

                initDetail3d: function () {
                    this.detailDM = new ht.DataModel();
                    this.detail3d = new ht.graph3d.Graph3dView(this.detailDM);

                    var detailView = this.detail3d.getView();
                    detailView.style.background = "#111922";
                    detailView.style.position = "absolute";
                    detailView.style.left = "0";
                    detailView.style.top = "0";
                    detailView.style.width = "100%";
                    detailView.style.height = "100%";
                    this.detail3d.setGridVisible(true);
                    this.detail3d.setGridGap(60);
                    this.detail3d.setGridSize(24);
                    this.detail3d.setEye([620, 430, 620]);
                    this.detail3d.setCenter([0, 130, 0]);
                    this.detail3d.setEditable(false);
                    this.detail3d.setMovableFunc(function () {
                        return false;
                    });

                    var host = document.getElementById("detail-host");
                    host.appendChild(detailView);

                    this.detailFloor = new ht.Node();
                    this.detailFloor.p3([0, -2, 0]);
                    this.detailFloor.s3([900, 4, 900]);
                    this.detailFloor.s({
                        "shape3d": "box",
                        "shape3d.color": "#1f2b38",
                        "shape3d.top.color": "#233342",
                        "shape3d.light": false
                    });
                    this.detailDM.add(this.detailFloor);
                },

                bindDetailInteraction: function () {
                    var self = this;
                    var sm = this.detailDM.getSelectionModel();
                    sm.setFilterFunc(function (data) {
                        return data && data.a("kind") === "detailBuilding";
                    });
                    sm.addSelectionChangeListener(function () {
                        var data = sm.getLastData();
                        if (!data) return;
                        var id = data.a("buildingId");
                        if (!id || !self.byId[id]) return;
                        self.showDetailPopup(self.byId[id], self.detailPopupAnchor);
                    });
                    this.detail3d.getView().addEventListener("click", function (e) {
                        if (!self.detailOpen) return;
                        var data = self.detail3d.getDataAt(e);
                        if (!data || data.a("kind") !== "detailBuilding") return;
                        var id = data.a("buildingId") || self.selectedId;
                        if (!id || !self.byId[id]) return;
                        self.selectedId = id;
                        var rect = self.detailHost.getBoundingClientRect();
                        self.detailPopupAnchor = {
                            x: e.clientX - rect.left,
                            y: e.clientY - rect.top
                        };
                        self.showDetailPopup(self.byId[id], self.detailPopupAnchor);
                    });
                },

                showDetailPopup: function (b, anchor) {
                    var perms = this.rolePermissions[this.currentRole] || this.rolePermissions.Operator;
                    if (!perms.detailPopup || !this.detailPopup) return;
                    this.detailPopupTitle.textContent = b.id + " says";
                    this.detailPopupBody.innerHTML =
                        '<div class="popup-cell">Power: <b>' + b.energy + ' kWh</b></div>' +
                        '<div class="popup-cell">Occupancy: <b>' + b.occupancy + '%</b></div>' +
                        '<div class="popup-cell">HVAC: <b>' + this.clamp(42 + Math.round(b.energy / 6), 40, 90) + '%</b></div>' +
                        '<div class="popup-cell">Water: <b>' + this.clamp(18 + Math.round(b.occupancy / 2), 8, 70) + ' L/min</b></div>' +
                        '<div class="popup-cell">CO2: <b>' + (420 + Math.round(b.occupancy * 7.2)) + ' ppm</b></div>' +
                        '<div class="popup-cell">Alarm: <b>' + (b.alarm ? "Active" : "Normal") + '</b></div>';
                    this.placeDetailPopup(anchor);
                    this.detailPopup.classList.add("visible");
                },

                placeDetailPopup: function (anchor) {
                    if (!this.detailPopup || !this.detailHost) return;
                    var hostRect = this.detailHost.getBoundingClientRect();
                    var popupRect = this.detailPopup.getBoundingClientRect();
                    var hostW = Math.max(0, hostRect.width);
                    var hostH = Math.max(0, hostRect.height);
                    var w = popupRect.width || 320;
                    var h = popupRect.height || 170;
                    var x;
                    var y;
                    var tailX;

                    if (anchor) {
                        x = this.clamp(anchor.x + 16, 8, Math.max(8, hostW - w - 8));
                        y = this.clamp(anchor.y - h - 14, 8, Math.max(8, hostH - h - 8));
                        tailX = this.clamp(anchor.x - x - 6, 12, w - 26);
                    }
                    else {
                        x = this.clamp(hostW * 0.5 - w * 0.5, 8, Math.max(8, hostW - w - 8));
                        y = this.clamp(hostH * 0.52 - h, 8, Math.max(8, hostH - h - 8));
                        tailX = w * 0.48;
                    }

                    this.detailPopup.style.left = x + "px";
                    this.detailPopup.style.top = y + "px";
                    this.detailPopup.style.setProperty("--tail-x", tailX + "px");
                },

                hideDetailPopup: function () {
                    if (this.detailPopup) this.detailPopup.classList.remove("visible");
                },

                loadOSMTexture: function () {
                    var self = this;
                    this.tileStats = { ok: 0, fail: 0 };
                    var meta = this.computeTileMeta(this.center.lat, this.center.lng, this.zoom, this.tileSpan);
                    this.mapMeta = meta;
                    var style = this.getMapStyle();
                    var textureScale = this.getTextureScale(style);
                    this.mapTextureScale = textureScale;

                    var canvas = document.createElement("canvas");
                    canvas.width = Math.round(meta.width * textureScale);
                    canvas.height = Math.round(meta.height * textureScale);
                    var ctx = canvas.getContext("2d");
                    ctx.setTransform(textureScale, 0, 0, textureScale, 0, 0);

                    var jobs = [];
                    for (var i = 0; i < meta.tiles.length; i++) {
                        jobs.push(this.loadTile(meta, meta.tiles[i], ctx));
                    }

                    return Promise.all(jobs).then(function () {
                        if (self.tileStats.ok === 0) {
                            self.drawFallbackMap(ctx, meta.width, meta.height);
                        }

                        self.drawTextureOverlays(ctx, meta.width, meta.height, style);
                        var registered = false;
                        try {
                            var dataUrl = canvas.toDataURL("image/png");
                            ht.Default.setImage(self.mapTextureName, canvas.width, canvas.height, dataUrl);
                            registered = true;
                        }
                        catch (ignore) {
                        }
                        if (!registered) {
                            ht.Default.setImage(self.mapTextureName, canvas);
                        }

                        var floorW = meta.width * self.unitsPerPixel;
                        var floorH = meta.height * self.unitsPerPixel;

                        self.floorNode.s3([floorW, 4, floorH]);
                        self.floorNode.s({
                            "shape3d": "rect",
                            "shape3d.color": "#1f2f3f",
                            "shape3d.image": self.mapTextureName,
                            "shape3d.top.color": "#f2f7fc",
                            "shape3d.top.image": self.mapTextureName,
                            "shape3d.top.visible": true,
                            "shape3d.bottom.color": "#1a2631",
                            "shape3d.light": false
                        });

                        if (self.tileStats.ok === 0) {
                            self.status.textContent = style.name + " z" + self.zoom + " unavailable, fallback rendered";
                        }
                        else if (self.tileStats.fail > 0) {
                            self.status.textContent = style.name + " z" + self.zoom + " partial (" + self.tileStats.ok + " ok / " + self.tileStats.fail + " failed, " + self.mapTextureScale + "x)";
                        }
                        else {
                            self.status.textContent = style.name + " z" + self.zoom + " ready (" + self.tileStats.ok + " tiles, " + self.mapTextureScale + "x)";
                        }
                        self.updateMapMetaChip();
                    });
                },

                getTextureScale: function (style) {
                    if (!style || !style.retina) return 1;
                    return window.devicePixelRatio && window.devicePixelRatio > 1 ? 2 : 1;
                },

                drawTextureOverlays: function (ctx, w, h, style) {
                    ctx.save();
                    ctx.globalCompositeOperation = "multiply";
                    ctx.fillStyle = (style && style.tint) || "rgba(23, 41, 58, 0.1)";
                    ctx.fillRect(0, 0, w, h);

                    ctx.globalCompositeOperation = "multiply";
                    var vignette = ctx.createRadialGradient(w * 0.52, h * 0.54, w * 0.18, w * 0.52, h * 0.54, w * 0.72);
                    vignette.addColorStop(0, "rgba(255, 255, 255, 0)");
                    var isDark = !!(style && style.name && style.name.toLowerCase().indexOf("dark") >= 0);
                    vignette.addColorStop(1, isDark ? "rgba(0, 0, 0, 0.03)" : "rgba(14, 25, 38, 0.1)");
                    ctx.fillStyle = vignette;
                    ctx.fillRect(0, 0, w, h);

                    ctx.globalCompositeOperation = "source-over";
                    var edge = ctx.createRadialGradient(w * 0.5, h * 0.5, w * 0.36, w * 0.5, h * 0.5, w * 0.72);
                    edge.addColorStop(0, "rgba(0, 0, 0, 0)");
                    edge.addColorStop(1, isDark ? "rgba(0, 0, 0, 0.02)" : "rgba(9, 18, 27, 0.08)");
                    ctx.fillStyle = edge;
                    ctx.fillRect(0, 0, w, h);
                    ctx.restore();
                },

                drawFallbackMap: function (ctx, w, h) {
                    ctx.save();
                    ctx.fillStyle = "#dce7f2";
                    ctx.fillRect(0, 0, w, h);

                    ctx.fillStyle = "rgba(166, 195, 157, 0.65)";
                    ctx.fillRect(0, 0, w, h * 0.28);
                    ctx.fillRect(0, h * 0.72, w, h * 0.28);

                    ctx.strokeStyle = "rgba(120, 139, 158, 0.65)";
                    ctx.lineWidth = 18;
                    ctx.beginPath();
                    ctx.moveTo(0, h * 0.54);
                    ctx.lineTo(w, h * 0.46);
                    ctx.stroke();

                    ctx.strokeStyle = "rgba(241, 248, 255, 0.95)";
                    ctx.lineWidth = 6;
                    for (var y = 70; y < h; y += 140) {
                        ctx.beginPath();
                        ctx.moveTo(0, y);
                        ctx.lineTo(w, y);
                        ctx.stroke();
                    }
                    for (var x = 70; x < w; x += 140) {
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, h);
                        ctx.stroke();
                    }

                    ctx.fillStyle = "rgba(121, 169, 123, 0.52)";
                    ctx.fillRect(w * 0.18, h * 0.18, w * 0.2, h * 0.16);
                    ctx.fillRect(w * 0.62, h * 0.58, w * 0.2, h * 0.16);
                    ctx.restore();
                },

                loadTile: function (meta, tile, ctx) {
                    var self = this;
                    var n = meta.n;
                    var tx = this.mod(tile.tx, n);
                    var ty = this.clamp(tile.ty, 0, n - 1);
                    var url = this.buildTileUrl(meta.zoom, tx, ty, tile.localX, tile.localY);

                    return new Promise(function (resolve) {
                        var img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = function () {
                            ctx.drawImage(img, tile.drawX, tile.drawY, self.tileSize, self.tileSize);
                            self.tileStats.ok += 1;
                            resolve();
                        };
                        img.onerror = function () {
                            ctx.fillStyle = "#dbe4ed";
                            ctx.fillRect(tile.drawX, tile.drawY, self.tileSize, self.tileSize);
                            self.tileStats.fail += 1;
                            resolve();
                        };
                        img.src = url;
                    });
                },

                computeTileMeta: function (lat, lng, zoom, span) {
                    var centerTile = this.latLngToTile(lat, lng, zoom);
                    var n = Math.pow(2, zoom);
                    var width = span * this.tileSize;
                    var height = span * this.tileSize;
                    var centerWorldPxX = centerTile.x * this.tileSize;
                    var centerWorldPxY = centerTile.y * this.tileSize;
                    var worldPxLeft = centerWorldPxX - width / 2;
                    var worldPxTop = centerWorldPxY - height / 2;
                    var startX = Math.floor(worldPxLeft / this.tileSize);
                    var startY = Math.floor(worldPxTop / this.tileSize);
                    var endX = Math.floor((worldPxLeft + width - 1) / this.tileSize);
                    var endY = Math.floor((worldPxTop + height - 1) / this.tileSize);
                    var tiles = [];

                    for (var ty = startY; ty <= endY; ty++) {
                        for (var tx = startX; tx <= endX; tx++) {
                            tiles.push({
                                tx: tx,
                                ty: ty,
                                localX: tx - startX,
                                localY: ty - startY,
                                drawX: tx * this.tileSize - worldPxLeft,
                                drawY: ty * this.tileSize - worldPxTop
                            });
                        }
                    }

                    return {
                        zoom: zoom,
                        n: n,
                        span: span,
                        width: width,
                        height: height,
                        centerTileX: centerTile.x,
                        centerTileY: centerTile.y,
                        startX: startX,
                        startY: startY,
                        endX: endX,
                        endY: endY,
                        tiles: tiles,
                        worldPxLeft: worldPxLeft,
                        worldPxTop: worldPxTop,
                        centerWorldPxX: centerWorldPxX,
                        centerWorldPxY: centerWorldPxY
                    };
                },

                latLngToTile: function (lat, lng, zoom) {
                    var n = Math.pow(2, zoom);
                    var latRad = lat * Math.PI / 180;
                    var x = (lng + 180) / 360 * n;
                    var y = (1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n;
                    return { x: x, y: y };
                },

                tileToLatLng: function (x, y, zoom) {
                    var n = Math.pow(2, zoom);
                    var lng = x / n * 360 - 180;
                    var latRad = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n)));
                    var lat = latRad * 180 / Math.PI;
                    return { lat: lat, lng: lng };
                },

                getMapStyle: function () {
                    return this.mapStyles[this.currentMapStyle] || this.mapStyles.osm;
                },

                buildTileUrl: function (zoom, x, y, localX, localY) {
                    var style = this.getMapStyle();
                    var subdomains = style.subdomains || [];
                    var subdomain = subdomains.length ? subdomains[(localX + localY) % subdomains.length] : "";
                    var retinaToken = style.retina && this.getTextureScale(style) > 1 ? "@2x" : "";
                    return style.url
                        .replace("{s}", subdomain)
                        .replace("{z}", String(zoom))
                        .replace("{x}", String(x))
                        .replace("{y}", String(y))
                        .replace("{r}", retinaToken);
                },

                updateAttribution: function () {
                    if (!this.attribution) return;
                    this.attribution.innerHTML = this.getMapStyle().attribution;
                },

                updateMapMetaChip: function () {
                    if (!this.mapMetaChip) return;
                    var style = this.getMapStyle();
                    var zoom = this.mapLoading ? this.zoom : (this.activeZoom || this.zoom);
                    this.mapMetaChip.textContent = "Style: " + style.name + " Â· Zoom " + zoom;
                    if (this.btnStyle) {
                        this.btnStyle.textContent = "Map Style: " + style.name;
                    }
                },

                cycleMapStyle: function () {
                    var keys = Object.keys(this.mapStyles);
                    var idx = keys.indexOf(this.currentMapStyle);
                    this.currentMapStyle = keys[(idx + 1) % keys.length];
                    this.updateAttribution();
                    this.updateMapMetaChip();
                    this.reloadMapForZoom(this.activeZoom || this.zoom, true);
                },

                updateCenterChip: function () {
                    if (!this.centerChip) return;
                    this.centerChip.textContent = "Center: " + this.center.lat.toFixed(4) + ", " + this.center.lng.toFixed(4);
                },

                promptMapCenter: function () {
                    if (this.detailOpen) {
                        this.closeDetailView();
                    }
                    this.openCenterModal();
                },

                parseLatLngInput: function (text) {
                    if (!text) return null;
                    var normalized = String(text).trim().replace(/[ï¼]/g, ",");
                    var parts = normalized.indexOf(",") >= 0 ? normalized.split(",") : normalized.split(/\s+/);
                    if (parts.length < 2) {
                        var nums = normalized.match(/[-+]?\d+(?:\.\d+)?/g);
                        if (!nums || nums.length < 2) return null;
                        parts = nums;
                    }
                    var lat = parseFloat(String(parts[0]).trim());
                    var lng = parseFloat(String(parts[1]).trim());
                    if (!isFinite(lat) || !isFinite(lng)) return null;
                    if (lat < -85 || lat > 85 || lng < -180 || lng > 180) return null;
                    return { lat: lat, lng: lng };
                },

                openCenterModal: function () {
                    if (!this.centerModal || !this.centerInput) return;
                    this.centerInput.value = this.center.lat.toFixed(6) + ", " + this.center.lng.toFixed(6);
                    this.centerModal.classList.add("visible");
                    var self = this;
                    setTimeout(function () {
                        self.centerInput.focus();
                        self.centerInput.select();
                    }, 20);
                },

                closeCenterModal: function () {
                    if (!this.centerModal) return;
                    this.centerModal.classList.remove("visible");
                },

                applyCenterFromInput: function () {
                    if (!this.centerInput) return;
                    var parsed = this.parseLatLngInput(this.centerInput.value);
                    if (!parsed) {
                        this.status.textContent = "Invalid center. Use latitude,longitude";
                        return;
                    }
                    this.closeCenterModal();
                    this.setMapCenter(parsed.lat, parsed.lng);
                },

                setMapCenter: function (lat, lng) {
                    if (this.editMode) {
                        this.syncMovedBuildings(true);
                        this.syncMovedJunctions(true);
                        this.syncMovedImportedAssets();
                    }
                    var fromCenter = { lat: this.center.lat, lng: this.center.lng };
                    var toCenter = { lat: lat, lng: lng };
                    var anchorZoom = this.activeZoom || this.zoom || this.baseZoom;
                    if (this.buildings.length) {
                        this.reanchorBuildingsForNewCenter(fromCenter, toCenter, anchorZoom);
                    }
                    if (this.junctions.length) {
                        this.reanchorJunctionsForNewCenter(fromCenter, toCenter, anchorZoom);
                    }
                    if (this.importedAssets.length) {
                        this.reanchorImportedAssetsForNewCenter(fromCenter, toCenter, anchorZoom);
                    }
                    if (this.customRoadPaths.length) {
                        this.reanchorCustomRoadPathsForNewCenter(fromCenter, toCenter, anchorZoom);
                    }
                    this.center = toCenter;
                    this.updateCenterChip();
                    this.status.textContent = "Center moved to " + lat.toFixed(4) + ", " + lng.toFixed(4);
                    this.reloadMapForZoom(anchorZoom, true);
                },

                reanchorBuildingsForNewCenter: function (fromCenter, toCenter, zoom) {
                    var fromTile = this.latLngToTile(fromCenter.lat, fromCenter.lng, zoom);
                    var toTile = this.latLngToTile(toCenter.lat, toCenter.lng, zoom);
                    for (var i = 0; i < this.buildings.length; i++) {
                        var b = this.buildings[i];
                        var tile = this.latLngToTile(b.lat, b.lng, zoom);
                        var nx = toTile.x + (tile.x - fromTile.x);
                        var ny = toTile.y + (tile.y - fromTile.y);
                        var ll = this.tileToLatLng(nx, ny, zoom);
                        b.lat = ll.lat;
                        b.lng = ll.lng;
                    }
                },

                reanchorJunctionsForNewCenter: function (fromCenter, toCenter, zoom) {
                    var fromTile = this.latLngToTile(fromCenter.lat, fromCenter.lng, zoom);
                    var toTile = this.latLngToTile(toCenter.lat, toCenter.lng, zoom);
                    for (var i = 0; i < this.junctions.length; i++) {
                        var j = this.junctions[i];
                        var tile = this.latLngToTile(j.lat, j.lng, zoom);
                        var nx = toTile.x + (tile.x - fromTile.x);
                        var ny = toTile.y + (tile.y - fromTile.y);
                        var ll = this.tileToLatLng(nx, ny, zoom);
                        j.lat = ll.lat;
                        j.lng = ll.lng;
                    }
                },

                reanchorImportedAssetsForNewCenter: function (fromCenter, toCenter, zoom) {
                    var fromTile = this.latLngToTile(fromCenter.lat, fromCenter.lng, zoom);
                    var toTile = this.latLngToTile(toCenter.lat, toCenter.lng, zoom);
                    for (var i = 0; i < this.importedAssets.length; i++) {
                        var a = this.importedAssets[i];
                        var tile = this.latLngToTile(a.lat, a.lng, zoom);
                        var nx = toTile.x + (tile.x - fromTile.x);
                        var ny = toTile.y + (tile.y - fromTile.y);
                        var ll = this.tileToLatLng(nx, ny, zoom);
                        a.lat = ll.lat;
                        a.lng = ll.lng;
                    }
                },

                reanchorCustomRoadPathsForNewCenter: function (fromCenter, toCenter, zoom) {
                    var fromTile = this.latLngToTile(fromCenter.lat, fromCenter.lng, zoom);
                    var toTile = this.latLngToTile(toCenter.lat, toCenter.lng, zoom);
                    for (var i = 0; i < this.customRoadPaths.length; i++) {
                        var path = this.customRoadPaths[i];
                        for (var j = 0; j < path.points.length; j++) {
                            var p = path.points[j];
                            var tile = this.latLngToTile(p.lat, p.lng, zoom);
                            var nx = toTile.x + (tile.x - fromTile.x);
                            var ny = toTile.y + (tile.y - fromTile.y);
                            var ll = this.tileToLatLng(nx, ny, zoom);
                            p.lat = ll.lat;
                            p.lng = ll.lng;
                        }
                    }
                    for (var k = 0; k < this.drawingRoadPoints.length; k++) {
                        var d = this.drawingRoadPoints[k];
                        var tile2 = this.latLngToTile(d.lat, d.lng, zoom);
                        var nx2 = toTile.x + (tile2.x - fromTile.x);
                        var ny2 = toTile.y + (tile2.y - fromTile.y);
                        var ll2 = this.tileToLatLng(nx2, ny2, zoom);
                        d.lat = ll2.lat;
                        d.lng = ll2.lng;
                    }
                },

                getFallbackStyleKey: function () {
                    if (this.currentMapStyle !== "osm" && this.mapStyles.osm) return "osm";
                    return null;
                },

                computeSpanForZoom: function (zoom) {
                    var span = Math.round(this.baseTileSpan * Math.pow(2, zoom - this.baseZoom));
                    return this.clamp(span, this.minTileSpan, this.maxTileSpan);
                },

                computeUnitsPerPixelForZoom: function (zoom) {
                    return this.baseUnitsPerPixel * Math.pow(2, this.baseZoom - zoom);
                },

                estimateZoomFromCamera: function () {
                    if (!this.world3d) return this.zoom;
                    var eye = this.world3d.getEye();
                    var center = this.world3d.getCenter();
                    var dx = eye[0] - center[0];
                    var dy = eye[1] - center[1];
                    var dz = eye[2] - center[2];
                    var dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                    if (dist > 3400) return this.minZoom;
                    if (dist > 2600) return this.baseZoom;
                    if (dist > 1750) return this.baseZoom + 1;
                    return this.maxZoom;
                },

                enforceWorldCameraBounds: function () {
                    if (!this.world3d || !this.mapMeta || this.detailOpen) return;
                    var center = this.world3d.getCenter();
                    var eye = this.world3d.getEye();
                    if (!center || !eye) return;

                    var clampedCenterXZ = this.clampWorldPointToMap(center[0], center[2], this.cameraCenterMargin);
                    var cx = clampedCenterXZ.x;
                    var cy = this.clamp(center[1], -20, 360);
                    var cz = clampedCenterXZ.z;

                    var vx = eye[0] - cx;
                    var vy = eye[1] - cy;
                    var vz = eye[2] - cz;
                    var dist = Math.sqrt(vx * vx + vy * vy + vz * vz);
                    if (!isFinite(dist) || dist < 1) {
                        vx = 0;
                        vy = this.cameraMinDistance * 0.72;
                        vz = this.cameraMinDistance * 0.72;
                        dist = Math.sqrt(vx * vx + vy * vy + vz * vz);
                    }
                    if (dist > this.cameraMaxDistance) {
                        var downScale = this.cameraMaxDistance / dist;
                        vx *= downScale;
                        vy *= downScale;
                        vz *= downScale;
                        dist = this.cameraMaxDistance;
                    }
                    if (dist < this.cameraMinDistance) {
                        var upScale = this.cameraMinDistance / dist;
                        vx *= upScale;
                        vy *= upScale;
                        vz *= upScale;
                        dist = this.cameraMinDistance;
                    }

                    var minVy = dist * 0.3;
                    if (vy < minVy) vy = minVy;
                    var maxVy = dist * 0.95;
                    if (vy > maxVy) vy = maxVy;

                    var ex = cx + vx;
                    var ey = cy + vy;
                    var ez = cz + vz;
                    var changed = Math.abs(cx - center[0]) > 0.5 ||
                        Math.abs(cy - center[1]) > 0.5 ||
                        Math.abs(cz - center[2]) > 0.5 ||
                        Math.abs(ex - eye[0]) > 0.5 ||
                        Math.abs(ey - eye[1]) > 0.5 ||
                        Math.abs(ez - eye[2]) > 0.5;
                    if (!changed) return;

                    this.world3d.setCenter([cx, cy, cz]);
                    this.world3d.setEye([ex, ey, ez]);
                },

                bindWorldInteraction: function () {
                    var self = this;
                    this.world3d.getView().addEventListener("click", function (e) {
                        if (!self.roadDrawMode || self.detailOpen) return;
                        var point = self.captureRoadPointFromEvent(e);
                        if (!point) {
                            self.status.textContent = "Road draw: click a building, junction, imported asset, or map surface.";
                            return;
                        }
                        self.addRoadWaypoint(point);
                        self.status.textContent = "Road draw waypoint added (" + self.drawingRoadPoints.length + ")";
                        e.preventDefault();
                    });
                    var listener = function (e) {
                        if (!e || !e.kind) return;
                        if (self.editMode && (e.kind === "betweenMove" || e.kind === "endMove" || e.kind === "betweenTranslate" || e.kind === "endTranslate")) {
                            self.syncMovedBuildings(false);
                            self.syncMovedJunctions(false);
                            self.syncMovedImportedAssets();
                        }
                        if (e.kind === "endZoom" || e.kind === "endPinch" || e.kind === "endWalk" || e.kind === "endPan") {
                            self.enforceWorldCameraBounds();
                            self.syncMapZoomWithCamera(false);
                        }
                    };
                    if (this.world3d.addinteractorListener) {
                        this.world3d.addinteractorListener(listener);
                    }
                    else if (this.world3d.addInteractorListener) {
                        this.world3d.addInteractorListener(listener);
                    }
                },

                setEditMode: function (enabled) {
                    var perms = this.rolePermissions[this.currentRole] || this.rolePermissions.Operator;
                    if (enabled && !perms.editLayout) {
                        this.status.textContent = "RBAC: current role cannot edit building layout";
                        return;
                    }
                    if (!!enabled === !!this.editMode) return;
                    if (enabled && this.detailOpen) {
                        this.closeDetailView();
                    }

                    this.editMode = !!enabled;
                    this.world3d.setEditable(this.editMode);
                    if (this.btnEdit) {
                        this.btnEdit.textContent = "Edit Layout: " + (this.editMode ? "On" : "Off");
                        this.btnEdit.classList.toggle("toggle-on", this.editMode);
                    }
                    if (this.btnEnter) {
                        this.btnEnter.disabled = this.editMode || this.roadDrawMode || !this.selectedId || !perms.enterBuilding;
                    }

                    if (this.editMode) {
                        this.startEditSync();
                        this.status.textContent = "Edit mode ON: drag buildings, road junctions, and imported assets";
                    }
                    else {
                        this.stopEditSync();
                        this.syncMovedBuildings(true);
                        this.syncMovedJunctions(true);
                        this.syncMovedImportedAssets();
                        this.status.textContent = "Edit mode OFF: layout fixed";
                    }
                    this.updateModeSwitcher();
                },

                startEditSync: function () {
                    var self = this;
                    if (this.editSyncTimer) clearInterval(this.editSyncTimer);
                    this.editSyncTimer = setInterval(function () {
                        self.syncMovedBuildings(false);
                        self.syncMovedJunctions(false);
                        self.syncMovedImportedAssets();
                    }, 140);
                },

                stopEditSync: function () {
                    if (this.editSyncTimer) {
                        clearInterval(this.editSyncTimer);
                        this.editSyncTimer = null;
                    }
                },

                syncMovedBuildings: function (forceRouteRebuild) {
                    if (!this.mapMeta || !this.buildings.length) return;
                    var changed = false;
                    for (var i = 0; i < this.buildings.length; i++) {
                        var b = this.buildings[i];
                        var p = b.node.p3();
                        if (!p) continue;
                        var nx = p[0];
                        var nz = p[2];
                        if (Math.abs(nx - b.x) < 0.5 && Math.abs(nz - b.z) < 0.5) continue;
                        b.x = nx;
                        b.z = nz;
                        b.district = this.computeDistrict(b.x, b.z);
                        this.syncBuildingLatLngFromWorld(b);
                        this.updateBuildingGeometry(b);
                        changed = true;
                    }
                    if (!changed) return;
                    this.updateDashboard();
                    if (forceRouteRebuild) this.rebuildNetworks();
                    else this.scheduleRouteRebuild();
                    if (this.selectedId && this.detailOpen && this.byId[this.selectedId]) {
                        this.prepareDetailScene(this.byId[this.selectedId]);
                    }
                },

                syncMovedJunctions: function (forceRouteRebuild) {
                    if (!this.mapMeta || !this.junctions.length) return;
                    var changed = false;
                    for (var i = 0; i < this.junctions.length; i++) {
                        var j = this.junctions[i];
                        var p = j.node && j.node.p3 ? j.node.p3() : null;
                        if (!p) continue;
                        var nx = p[0];
                        var nz = p[2];
                        if (Math.abs(nx - j.x) < 0.5 && Math.abs(nz - j.z) < 0.5) continue;
                        j.x = nx;
                        j.z = nz;
                        this.syncJunctionLatLngFromWorld(j);
                        changed = true;
                    }
                    if (!changed) return;
                    if (forceRouteRebuild) this.rebuildNetworks();
                    else this.scheduleRouteRebuild();
                },

                syncMovedImportedAssets: function () {
                    if (!this.mapMeta || !this.importedAssets.length) return;
                    for (var i = 0; i < this.importedAssets.length; i++) {
                        var a = this.importedAssets[i];
                        var p = a.node && a.node.p3 ? a.node.p3() : null;
                        if (!p) continue;
                        var nx = p[0];
                        var nz = p[2];
                        if (Math.abs(nx - a.x) < 0.5 && Math.abs(nz - a.z) < 0.5) continue;
                        a.x = nx;
                        a.z = nz;
                        this.syncImportedAssetLatLngFromWorld(a);
                    }
                },

                scheduleRouteRebuild: function () {
                    var self = this;
                    if (this.routeRebuildTimer) {
                        clearTimeout(this.routeRebuildTimer);
                    }
                    this.routeRebuildTimer = setTimeout(function () {
                        self.routeRebuildTimer = null;
                        self.rebuildNetworks();
                    }, 120);
                },

                toggleRoutes: function () {
                    this.routesVisible = !this.routesVisible;
                    this.updateRouteVisibility();
                    if (this.btnRoutes) {
                        this.btnRoutes.textContent = "Routes: " + (this.routesVisible ? "On" : "Off");
                        this.btnRoutes.classList.toggle("toggle-on", this.routesVisible);
                    }
                },

                clearRouteNetwork: function () {
                    for (var i = 0; i < this.routeNodes.length; i++) {
                        this.worldDM.remove(this.routeNodes[i]);
                    }
                    this.routeNodes = [];
                },

                clearJunctionRoadNetwork: function () {
                    for (var i = 0; i < this.junctionRoadNodes.length; i++) {
                        this.worldDM.remove(this.junctionRoadNodes[i]);
                    }
                    this.junctionRoadNodes = [];
                },

                rebuildNetworks: function () {
                    this.createRouteNetwork();
                    this.createJunctionRoadNetwork();
                },

                createRouteNetwork: function () {
                    if (!this.worldDM || !this.buildings.length) return;
                    this.clearRouteNetwork();
                    var pairs = this.collectRoutePairs(2, 980);
                    for (var i = 0; i < pairs.length; i++) {
                        var a = this.buildings[pairs[i].a];
                        var b = this.buildings[pairs[i].b];
                        var dx = b.x - a.x;
                        var dz = b.z - a.z;
                        var len = Math.sqrt(dx * dx + dz * dz);
                        if (len < 6) continue;
                        var segment = new ht.Node();
                        segment.p3([(a.x + b.x) / 2, 8, (a.z + b.z) / 2]);
                        segment.s3([7, 2.8, len]);
                        segment.r3([0, Math.atan2(dx, dz), 0]);
                        segment.s({
                            "shape3d": "box",
                            "shape3d.color": "rgba(70, 201, 255, 0.62)",
                            "shape3d.top.color": "rgba(183, 238, 255, 0.86)",
                            "shape3d.transparent": true,
                            "shape3d.light": true
                        });
                        segment.a("kind", "route");
                        if (segment.setVisible) segment.setVisible(this.routesVisible);
                        this.worldDM.add(segment);
                        this.routeNodes.push(segment);
                    }
                    this.world3d.invalidate();
                },

                collectRoutePairs: function (neighborsPerBuilding, maxDistance) {
                    var pairMap = {};
                    for (var i = 0; i < this.buildings.length; i++) {
                        var candidates = [];
                        var a = this.buildings[i];
                        for (var j = 0; j < this.buildings.length; j++) {
                            if (i === j) continue;
                            var b = this.buildings[j];
                            var dx = b.x - a.x;
                            var dz = b.z - a.z;
                            var d = Math.sqrt(dx * dx + dz * dz);
                            if (d > maxDistance) continue;
                            candidates.push({ j: j, d: d });
                        }
                        candidates.sort(function (m, n) { return m.d - n.d; });
                        for (var k = 0; k < candidates.length && k < neighborsPerBuilding; k++) {
                            var idx = candidates[k].j;
                            var min = i < idx ? i : idx;
                            var max = i < idx ? idx : i;
                            pairMap[min + ":" + max] = { a: min, b: max };
                        }
                    }
                    var out = [];
                    for (var key in pairMap) {
                        if (Object.prototype.hasOwnProperty.call(pairMap, key)) {
                            out.push(pairMap[key]);
                        }
                    }
                    return out;
                },

                collectJunctionPairs: function (neighborsPerJunction, maxDistance) {
                    var pairMap = {};
                    for (var i = 0; i < this.junctions.length; i++) {
                        var candidates = [];
                        var a = this.junctions[i];
                        for (var j = 0; j < this.junctions.length; j++) {
                            if (i === j) continue;
                            var b = this.junctions[j];
                            var dx = b.x - a.x;
                            var dz = b.z - a.z;
                            var d = Math.sqrt(dx * dx + dz * dz);
                            if (d > maxDistance) continue;
                            candidates.push({ j: j, d: d });
                        }
                        candidates.sort(function (m, n) { return m.d - n.d; });
                        for (var k = 0; k < candidates.length && k < neighborsPerJunction; k++) {
                            var idx = candidates[k].j;
                            var min = i < idx ? i : idx;
                            var max = i < idx ? idx : i;
                            pairMap[min + ":" + max] = { a: min, b: max };
                        }
                    }
                    var out = [];
                    for (var key in pairMap) {
                        if (Object.prototype.hasOwnProperty.call(pairMap, key)) {
                            out.push(pairMap[key]);
                        }
                    }
                    return out;
                },

                createJunctionRoadNetwork: function () {
                    if (!this.worldDM || !this.junctions.length) return;
                    this.clearJunctionRoadNetwork();
                    var pairs = this.collectJunctionPairs(2, 980);
                    for (var i = 0; i < pairs.length; i++) {
                        var a = this.junctions[pairs[i].a];
                        var b = this.junctions[pairs[i].b];
                        this.createRoadSegmentNode(a.x, a.z, b.x, b.z, 5.5, "rgba(96, 175, 205, 0.55)", "junctionRoad");
                    }

                    for (var n = 0; n < this.buildings.length; n++) {
                        var building = this.buildings[n];
                        var nearest = this.findNearestJunction(building.x, building.z, 820);
                        if (!nearest) continue;
                        this.createRoadSegmentNode(building.x, building.z, nearest.x, nearest.z, 4.2, "rgba(117, 196, 226, 0.42)", "buildingRoad");
                    }
                    this.world3d.invalidate();
                },

                findNearestJunction: function (x, z, maxDistance) {
                    var best = null;
                    var bestD = Infinity;
                    for (var i = 0; i < this.junctions.length; i++) {
                        var j = this.junctions[i];
                        var dx = j.x - x;
                        var dz = j.z - z;
                        var d = Math.sqrt(dx * dx + dz * dz);
                        if (d < bestD && d <= maxDistance) {
                            bestD = d;
                            best = j;
                        }
                    }
                    return best;
                },

                createRoadSegmentNode: function (x1, z1, x2, z2, width, color, kind, targetNodes) {
                    var dx = x2 - x1;
                    var dz = z2 - z1;
                    var len = Math.sqrt(dx * dx + dz * dz);
                    if (len < 5) return;
                    var segment = new ht.Node();
                    segment.p3([(x1 + x2) / 2, 6, (z1 + z2) / 2]);
                    segment.s3([width, 2.2, len]);
                    segment.r3([0, Math.atan2(dx, dz), 0]);
                    segment.s({
                        "shape3d": "box",
                        "shape3d.color": color,
                        "shape3d.top.color": "rgba(188, 233, 255, 0.78)",
                        "shape3d.transparent": true,
                        "shape3d.light": true
                    });
                    segment.a("kind", kind || "junctionRoad");
                    if (segment.setVisible) segment.setVisible(this.routesVisible);
                    this.worldDM.add(segment);
                    if (targetNodes && targetNodes.push) targetNodes.push(segment);
                    else this.junctionRoadNodes.push(segment);
                },

                updateRouteVisibility: function () {
                    for (var i = 0; i < this.routeNodes.length; i++) {
                        if (this.routeNodes[i].setVisible) {
                            this.routeNodes[i].setVisible(this.routesVisible);
                        }
                    }
                    for (var j = 0; j < this.junctionRoadNodes.length; j++) {
                        if (this.junctionRoadNodes[j].setVisible) {
                            this.junctionRoadNodes[j].setVisible(this.routesVisible);
                        }
                    }
                    for (var n = 0; n < this.customRoadNodes.length; n++) {
                        if (this.customRoadNodes[n].setVisible) {
                            this.customRoadNodes[n].setVisible(this.routesVisible);
                        }
                    }
                    for (var d = 0; d < this.draftRoadNodes.length; d++) {
                        if (this.draftRoadNodes[d].setVisible) {
                            this.draftRoadNodes[d].setVisible(this.routesVisible);
                        }
                    }
                    this.world3d.invalidate();
                },

                updateRoadDrawUi: function () {
                    if (this.btnRoadDraw) {
                        this.btnRoadDraw.textContent = this.roadDrawMode ? "Save Road Path" : "Road Path: Off";
                        this.btnRoadDraw.classList.toggle("toggle-on", this.roadDrawMode);
                    }
                    if (this.roadChip) {
                        this.roadChip.textContent = this.roadDrawMode ?
                            ("Road Draw: " + this.drawingRoadPoints.length + " waypoint(s)") :
                            ("Road Draw: Off");
                    }
                    var perms = this.rolePermissions[this.currentRole] || this.rolePermissions.Operator;
                    if (this.btnEnter) {
                        this.btnEnter.disabled = this.editMode || this.roadDrawMode || !this.selectedId || !perms.enterBuilding;
                    }
                    this.updateModeSwitcher();
                },

                toggleRoadDrawMode: function () {
                    if (this.roadDrawMode && this.drawingRoadPoints.length >= 2) {
                        this.commitRoadDrawPath();
                        return;
                    }
                    this.setRoadDrawMode(!this.roadDrawMode);
                },

                setRoadDrawMode: function (enabled, discardOnly) {
                    var perms = this.rolePermissions[this.currentRole] || this.rolePermissions.Operator;
                    if (enabled && !perms.editLayout) {
                        this.status.textContent = "RBAC: current role cannot draw road paths";
                        return;
                    }
                    this.roadDrawMode = !!enabled;
                    if (!this.roadDrawMode || discardOnly) {
                        this.drawingRoadPoints = [];
                        this.clearDraftRoadPath();
                    }
                    if (this.roadDrawMode && this.detailOpen) {
                        this.closeDetailView();
                    }
                    this.updateRoadDrawUi();
                    if (this.roadDrawMode) {
                        this.status.textContent = "Road draw ON: click buildings, junctions, or map surface to add waypoints. Click button again to save.";
                    }
                    else if (!discardOnly) {
                        this.status.textContent = "Road draw OFF";
                    }
                },

                captureRoadPointFromEvent: function (e) {
                    if (!this.world3d || !this.mapMeta) return null;
                    var data = this.world3d.getDataAt(e);
                    var p = null;
                    if (data && data.p3) {
                        var kind = data.a ? data.a("kind") : null;
                        if (kind === "buildingPart") {
                            var id = data.a("buildingId");
                            if (id && this.byId[id] && this.byId[id].node) {
                                p = this.byId[id].node.p3();
                            }
                        }
                        else if (kind === "building" || kind === "junction" || kind === "importedAsset") {
                            p = data.p3();
                        }
                    }
                    if (!p && this.world3d.getDataInfoAt) {
                        var info = this.world3d.getDataInfoAt(e);
                        p = this.extract3dPointFromInfo(info);
                    }
                    if (!p) return null;
                    var clamped = this.clampWorldPointToMap(p[0], p[2], 12);
                    var latLng = this.worldToLatLng(clamped.x, clamped.z);
                    return {
                        x: clamped.x,
                        z: clamped.z,
                        lat: latLng.lat,
                        lng: latLng.lng
                    };
                },

                extract3dPointFromInfo: function (info) {
                    if (!info) return null;
                    var keys = ["point3d", "intersectPoint", "worldPoint", "point", "position3d", "position", "p3"];
                    for (var i = 0; i < keys.length; i++) {
                        var p = this.normalize3dPoint(info[keys[i]]);
                        if (p) return p;
                    }
                    if (info.data && info.data.p3) {
                        return this.normalize3dPoint(info.data.p3());
                    }
                    return null;
                },

                normalize3dPoint: function (value) {
                    if (!value) return null;
                    if (Object.prototype.toString.call(value) === "[object Array]" && value.length >= 3) {
                        return [Number(value[0]) || 0, Number(value[1]) || 0, Number(value[2]) || 0];
                    }
                    if (typeof value === "object" && value.x != null && value.y != null && value.z != null) {
                        return [Number(value.x) || 0, Number(value.y) || 0, Number(value.z) || 0];
                    }
                    return null;
                },

                addRoadWaypoint: function (point) {
                    this.drawingRoadPoints.push({
                        x: point.x,
                        z: point.z,
                        lat: point.lat,
                        lng: point.lng
                    });
                    this.renderDraftRoadPath();
                    this.updateRoadDrawUi();
                },

                clearDraftRoadPath: function () {
                    for (var i = 0; i < this.draftRoadNodes.length; i++) {
                        this.worldDM.remove(this.draftRoadNodes[i]);
                    }
                    this.draftRoadNodes = [];
                    this.world3d.invalidate();
                },

                renderDraftRoadPath: function () {
                    this.clearDraftRoadPath();
                    if (!this.drawingRoadPoints.length) return;
                    var i;
                    for (i = 0; i < this.drawingRoadPoints.length; i++) {
                        var p = this.drawingRoadPoints[i];
                        var marker = new ht.Node();
                        marker.p3([p.x, 10, p.z]);
                        marker.s3([9, 9, 9]);
                        marker.s({
                            "shape3d": "sphere",
                            "shape3d.color": "rgba(255, 225, 153, 0.92)",
                            "shape3d.light": true
                        });
                        marker.a("kind", "roadDraft");
                        if (marker.setVisible) marker.setVisible(this.routesVisible);
                        this.worldDM.add(marker);
                        this.draftRoadNodes.push(marker);
                    }
                    var poly = this.buildRoadPolyline(this.drawingRoadPoints);
                    for (i = 0; i < poly.length - 1; i++) {
                        this.createRoadSegmentNode(poly[i].x, poly[i].z, poly[i + 1].x, poly[i + 1].z, 5.6, "rgba(255, 223, 158, 0.66)", "roadDraft", this.draftRoadNodes);
                    }
                    this.world3d.invalidate();
                },

                commitRoadDrawPath: function () {
                    if (this.drawingRoadPoints.length < 2) {
                        this.setRoadDrawMode(false, true);
                        this.status.textContent = "Road draw canceled (need at least 2 waypoints)";
                        return;
                    }
                    this.customRoadCounter += 1;
                    this.customRoadPaths.push({
                        id: "RPATH-" + this.pad(this.customRoadCounter, 3),
                        points: this.drawingRoadPoints.map(function (p) {
                            return { x: p.x, z: p.z, lat: p.lat, lng: p.lng };
                        })
                    });
                    this.drawingRoadPoints = [];
                    this.clearDraftRoadPath();
                    this.setRoadDrawMode(false);
                    this.renderCustomRoadPaths();
                    this.status.textContent = "Custom road path saved";
                },

                buildRoadPolyline: function (points) {
                    if (!points || points.length < 2) return points ? points.slice() : [];
                    var out = [{ x: points[0].x, z: points[0].z }];
                    for (var i = 1; i < points.length; i++) {
                        var a = points[i - 1];
                        var b = points[i];
                        var dx = b.x - a.x;
                        var dz = b.z - a.z;
                        var needBend = Math.abs(dx) > 12 && Math.abs(dz) > 12;
                        if (needBend) {
                            var via = Math.abs(dx) > Math.abs(dz) ? { x: b.x, z: a.z } : { x: a.x, z: b.z };
                            out.push(via);
                        }
                        out.push({ x: b.x, z: b.z });
                    }
                    return out;
                },

                renderCustomRoadPaths: function () {
                    for (var i = 0; i < this.customRoadNodes.length; i++) {
                        this.worldDM.remove(this.customRoadNodes[i]);
                    }
                    this.customRoadNodes = [];
                    for (var p = 0; p < this.customRoadPaths.length; p++) {
                        var path = this.customRoadPaths[p];
                        var poly = this.buildRoadPolyline(path.points);
                        for (var i2 = 0; i2 < poly.length - 1; i2++) {
                            this.createRoadSegmentNode(poly[i2].x, poly[i2].z, poly[i2 + 1].x, poly[i2 + 1].z, 6.8, "rgba(239, 246, 255, 0.56)", "customRoad", this.customRoadNodes);
                        }
                    }
                    this.updateRouteVisibility();
                },

                worldToLatLng: function (x, z) {
                    if (!this.mapMeta) return { lat: this.center.lat, lng: this.center.lng };
                    var worldPx = this.worldXZToWorldPx(x, z);
                    var tileX = worldPx.x / this.tileSize;
                    var tileY = worldPx.y / this.tileSize;
                    return this.tileToLatLng(tileX, tileY, this.mapMeta.zoom);
                },

                startZoomMonitor: function () {
                    var self = this;
                    if (this.zoomMonitorTimer) {
                        clearInterval(this.zoomMonitorTimer);
                    }
                    this.zoomMonitorTimer = setInterval(function () {
                        self.enforceWorldCameraBounds();
                        self.syncMapZoomWithCamera(false);
                    }, 900);
                },

                syncMapZoomWithCamera: function (force) {
                    if (this.detailOpen || !this.mapMeta) return;
                    var targetZoom = this.clamp(this.estimateZoomFromCamera(), this.minZoom, this.maxZoom);
                    if (force) {
                        this.zoomCandidate = null;
                        this.zoomCandidateCount = 0;
                        this.reloadMapForZoom(targetZoom, true);
                        return;
                    }
                    if (this.activeZoom != null && Math.abs(targetZoom - this.activeZoom) > 1) {
                        targetZoom = this.activeZoom + (targetZoom > this.activeZoom ? 1 : -1);
                    }
                    if (targetZoom === this.activeZoom) {
                        this.zoomCandidate = null;
                        this.zoomCandidateCount = 0;
                        return;
                    }
                    if (targetZoom !== this.zoomCandidate) {
                        this.zoomCandidate = targetZoom;
                        this.zoomCandidateCount = 1;
                        return;
                    }
                    this.zoomCandidateCount += 1;
                    if (this.zoomCandidateCount < 3) return;
                    this.zoomCandidate = null;
                    this.zoomCandidateCount = 0;
                    this.reloadMapForZoom(targetZoom, force);
                },

                reloadMapForZoom: function (targetZoom, force) {
                    var self = this;
                    if (this.editMode) {
                        this.syncMovedBuildings(true);
                        this.syncMovedJunctions(true);
                        this.syncMovedImportedAssets();
                    }
                    targetZoom = this.clamp(targetZoom, this.minZoom, this.maxZoom);
                    if (!force && this.mapMeta && this.activeZoom === targetZoom) {
                        return Promise.resolve();
                    }
                    if (this.mapLoading) {
                        this.pendingZoom = targetZoom;
                        this.pendingForce = this.pendingForce || !!force;
                        return Promise.resolve();
                    }

                    this.mapLoading = true;
                    this.zoom = targetZoom;
                    this.tileSpan = this.computeSpanForZoom(targetZoom);
                    this.unitsPerPixel = this.computeUnitsPerPixelForZoom(targetZoom);
                    this.status.textContent = "Loading " + this.getMapStyle().name + " z" + targetZoom + "...";
                    this.updateMapMetaChip();

                    var token = ++this.mapReloadToken;
                    var done = function () {
                        self.mapLoading = false;
                        if (self.pendingZoom != null && (self.pendingZoom !== self.activeZoom || self.pendingForce)) {
                            var next = self.pendingZoom;
                            var nextForce = self.pendingForce;
                            self.pendingZoom = null;
                            self.pendingForce = false;
                            self.reloadMapForZoom(next, nextForce);
                        }
                        else {
                            self.pendingZoom = null;
                            self.pendingForce = false;
                        }
                    };

                    return this.loadOSMTexture().then(function () {
                        if (token !== self.mapReloadToken) return;
                        if (self.tileStats.ok === 0) {
                            var fallbackStyle = self.getFallbackStyleKey();
                            if (fallbackStyle) {
                                self.currentMapStyle = fallbackStyle;
                                self.updateAttribution();
                                self.updateMapMetaChip();
                                self.status.textContent = "No tiles loaded from selected source, trying " + self.getMapStyle().name + "...";
                                return self.loadOSMTexture();
                            }
                        }
                    }).then(function () {
                        if (token !== self.mapReloadToken) return;
                        self.activeZoom = targetZoom;
                        if (self.buildings.length) {
                            self.reprojectBuildingsToCurrentMap();
                            self.updateDashboard();
                        }
                        else {
                            if (self.junctions.length) self.reprojectJunctionsToCurrentMap();
                            if (self.importedAssets.length) self.reprojectImportedAssetsToCurrentMap();
                            self.reprojectCustomRoadPathsToCurrentMap();
                            self.rebuildNetworks();
                        }
                        self.enforceWorldCameraBounds();
                        self.world3d.invalidate();
                    }).catch(function (err) {
                        self.showBootError(err && err.message ? err.message : String(err));
                        self.status.textContent = "Map refresh failed";
                    }).then(done, done);
                },

                reprojectBuildingsToCurrentMap: function () {
                    if (!this.mapMeta) return;
                    for (var i = 0; i < this.buildings.length; i++) {
                        var b = this.buildings[i];
                        var tile = this.latLngToTile(b.lat, b.lng, this.mapMeta.zoom);
                        var world = this.worldPxToWorldXZ(tile.x * this.tileSize, tile.y * this.tileSize);
                        b.x = world.x;
                        b.z = world.z;
                        b.district = this.computeDistrict(b.x, b.z);
                        this.updateBuildingGeometry(b);
                    }
                    this.reprojectJunctionsToCurrentMap();
                    this.reprojectImportedAssetsToCurrentMap();
                    this.reprojectCustomRoadPathsToCurrentMap();
                    this.rebuildNetworks();
                    if (this.selectedId && this.detailOpen) {
                        this.prepareDetailScene(this.byId[this.selectedId]);
                    }
                },

                reprojectJunctionsToCurrentMap: function () {
                    if (!this.mapMeta || !this.junctions.length) return;
                    for (var i = 0; i < this.junctions.length; i++) {
                        var j = this.junctions[i];
                        var tile = this.latLngToTile(j.lat, j.lng, this.mapMeta.zoom);
                        var world = this.worldPxToWorldXZ(tile.x * this.tileSize, tile.y * this.tileSize);
                        j.x = world.x;
                        j.z = world.z;
                        if (j.node) {
                            var p = j.node.p3();
                            j.node.p3([j.x, (p ? p[1] : 9), j.z]);
                        }
                    }
                },

                reprojectImportedAssetsToCurrentMap: function () {
                    if (!this.mapMeta || !this.importedAssets.length) return;
                    for (var i = 0; i < this.importedAssets.length; i++) {
                        var a = this.importedAssets[i];
                        var tile = this.latLngToTile(a.lat, a.lng, this.mapMeta.zoom);
                        var world = this.worldPxToWorldXZ(tile.x * this.tileSize, tile.y * this.tileSize);
                        a.x = world.x;
                        a.z = world.z;
                        if (a.node) {
                            var p = a.node.p3();
                            a.node.p3([a.x, (p ? p[1] : 46), a.z]);
                        }
                    }
                },

                reprojectCustomRoadPathsToCurrentMap: function () {
                    if (!this.mapMeta) return;
                    var i;
                    var j;
                    for (i = 0; i < this.customRoadPaths.length; i++) {
                        var path = this.customRoadPaths[i];
                        for (j = 0; j < path.points.length; j++) {
                            var p = path.points[j];
                            var tile = this.latLngToTile(p.lat, p.lng, this.mapMeta.zoom);
                            var world = this.worldPxToWorldXZ(tile.x * this.tileSize, tile.y * this.tileSize);
                            p.x = world.x;
                            p.z = world.z;
                        }
                    }
                    for (i = 0; i < this.drawingRoadPoints.length; i++) {
                        var draftP = this.drawingRoadPoints[i];
                        var tile2 = this.latLngToTile(draftP.lat, draftP.lng, this.mapMeta.zoom);
                        var world2 = this.worldPxToWorldXZ(tile2.x * this.tileSize, tile2.y * this.tileSize);
                        draftP.x = world2.x;
                        draftP.z = world2.z;
                    }
                    this.renderCustomRoadPaths();
                    this.renderDraftRoadPath();
                },

                worldPxToWorldXZ: function (pxX, pxY) {
                    var dxPx = pxX - this.mapMeta.centerWorldPxX;
                    var dyPx = pxY - this.mapMeta.centerWorldPxY;
                    return {
                        x: dxPx * this.unitsPerPixel,
                        z: dyPx * this.unitsPerPixel
                    };
                },

                worldXZToWorldPx: function (x, z) {
                    return {
                        x: this.mapMeta.centerWorldPxX + x / this.unitsPerPixel,
                        y: this.mapMeta.centerWorldPxY + z / this.unitsPerPixel
                    };
                },

                syncBuildingLatLngFromWorld: function (b) {
                    if (!this.mapMeta) return;
                    var worldPx = this.worldXZToWorldPx(b.x, b.z);
                    var tileX = worldPx.x / this.tileSize;
                    var tileY = worldPx.y / this.tileSize;
                    var ll = this.tileToLatLng(tileX, tileY, this.mapMeta.zoom);
                    b.lat = ll.lat;
                    b.lng = ll.lng;
                },

                syncJunctionLatLngFromWorld: function (j) {
                    if (!this.mapMeta) return;
                    var worldPx = this.worldXZToWorldPx(j.x, j.z);
                    var tileX = worldPx.x / this.tileSize;
                    var tileY = worldPx.y / this.tileSize;
                    var ll = this.tileToLatLng(tileX, tileY, this.mapMeta.zoom);
                    j.lat = ll.lat;
                    j.lng = ll.lng;
                },

                syncImportedAssetLatLngFromWorld: function (a) {
                    if (!this.mapMeta) return;
                    var worldPx = this.worldXZToWorldPx(a.x, a.z);
                    var tileX = worldPx.x / this.tileSize;
                    var tileY = worldPx.y / this.tileSize;
                    var ll = this.tileToLatLng(tileX, tileY, this.mapMeta.zoom);
                    a.lat = ll.lat;
                    a.lng = ll.lng;
                },

                updateBuildingGeometry: function (b) {
                    var h = b.displayHeight || this.energyToHeight(b.energy);
                    var fx = b.footX || b.foot;
                    var fz = b.footZ || b.foot;
                    b.displayHeight = h;
                    b.node.p3([b.x, h / 2, b.z]);
                    b.node.s3([fx, h, fz]);

                    if (b.roofNode) {
                        b.roofNode.p3([b.x, h + 3, b.z]);
                        b.roofNode.s3([fx * 0.84, 6, fz * 0.84]);
                    }
                    if (b.wingNode) {
                        var wingH = Math.max(24, h * 0.42);
                        b.wingNode.p3([b.x + fx * 0.3, wingH / 2, b.z - fz * 0.52]);
                        b.wingNode.s3([Math.max(4, fx * 0.16), wingH, Math.max(2, fz * 0.2)]);
                    }
                    if (b.crownNode) {
                        b.crownNode.p3([b.x - fx * 0.24, h + 9, b.z + fz * 0.18]);
                        b.crownNode.s3([Math.max(6, fx * 0.24), 8, Math.max(6, fz * 0.24)]);
                    }
                },

                createBuildingDetailParts: function (b) {
                    var roof = new ht.Node();
                    roof.s({
                        "shape3d": "box",
                        "shape3d.color": this.brighten(b.baseColor, 0.34),
                        "shape3d.top.color": this.brighten(b.baseColor, 0.48),
                        "shape3d.light": true
                    });
                    roof.a("kind", "buildingPart");
                    roof.a("buildingId", b.id);
                    this.worldDM.add(roof);
                    b.roofNode = roof;

                    var wing = new ht.Node();
                    wing.s({
                        "shape3d": "box",
                        "shape3d.color": this.blendColor(b.baseColor, "#dbe8f7", 0.24),
                        "shape3d.light": true
                    });
                    wing.a("kind", "buildingPart");
                    wing.a("buildingId", b.id);
                    this.worldDM.add(wing);
                    b.wingNode = wing;

                    var crown = new ht.Node();
                    crown.s({
                        "shape3d": "box",
                        "shape3d.color": this.blendColor(b.baseColor, "#ffffff", 0.52),
                        "shape3d.light": true
                    });
                    crown.a("kind", "buildingPart");
                    crown.a("buildingId", b.id);
                    this.worldDM.add(crown);
                    b.crownNode = crown;
                },

                createBuildings: function (count) {
                    var types = [
                        { name: "Residential", color: "#4f46e5" },
                        { name: "Commercial", color: "#e67e22" },
                        { name: "Public Utility", color: "#16a085" },
                        { name: "Industrial", color: "#95a5a6" }
                    ];

                    var margin = 70;
                    var i;
                    for (i = 1; i <= count; i++) {
                        var px = this.rand(margin, this.mapMeta.width - margin);
                        var py = this.rand(margin, this.mapMeta.height - margin);

                        var worldPxX = this.mapMeta.worldPxLeft + px;
                        var worldPxY = this.mapMeta.worldPxTop + py;
                        var tileX = worldPxX / this.tileSize;
                        var tileY = worldPxY / this.tileSize;
                        var ll = this.tileToLatLng(tileX, tileY, this.mapMeta.zoom);
                        var world = this.worldPxToWorldXZ(worldPxX, worldPxY);

                        var type = types[Math.floor(Math.random() * types.length)];
                        var energy = Math.round(this.rand(30, 245));
                        var occupancy = Math.round(this.rand(15, 98));
                        var alarm = Math.random() < 0.14;
                        var district = this.computeDistrict(world.x, world.z);

                        var id = "BLD-" + this.pad(i, 3);
                        var footX = this.rand(26, 46);
                        var footZ = this.rand(24, 50);
                        var foot = (footX + footZ) / 2;
                        var height = this.energyToHeight(energy);

                        var node = new ht.Node();
                        node.setName(id);
                        node.p3([world.x, height / 2, world.z]);
                        node.s3([footX, height, footZ]);
                        node.s({
                            "shape3d": "box",
                            "shape3d.color": type.color,
                            "shape3d.light": true,
                            "shape3d.top.color": this.brighten(type.color, 0.16),
                            "wf.visible": false,
                            "select.type": "shadow",
                            "select.color": "#ffd166",
                            "select.width": 4
                        });
                        node.a("kind", "building");
                        node.a("buildingId", id);
                        this.worldDM.add(node);

                        var b = {
                            id: id,
                            lat: ll.lat,
                            lng: ll.lng,
                            x: world.x,
                            z: world.z,
                            district: district,
                            type: type.name,
                            baseColor: type.color,
                            energy: energy,
                            occupancy: occupancy,
                            alarm: alarm,
                            foot: foot,
                            footX: footX,
                            footZ: footZ,
                            displayHeight: height,
                            node: node
                        };

                        this.createBuildingDetailParts(b);
                        this.updateBuildingGeometry(b);

                        this.buildings.push(b);
                        this.byId[id] = b;
                    }
                },

                createRoadJunctions: function (count) {
                    this.clearRoadJunctions();
                    if (!this.worldDM || !this.mapMeta) return;
                    count = Math.max(4, count || 16);
                    var i;
                    for (i = 0; i < count; i++) {
                        var source = this.buildings.length ? this.buildings[i % this.buildings.length] : null;
                        var x;
                        var z;
                        if (source) {
                            x = source.x + this.rand(-240, 240);
                            z = source.z + this.rand(-240, 240);
                        }
                        else {
                            var px = this.rand(80, this.mapMeta.width - 80);
                            var py = this.rand(80, this.mapMeta.height - 80);
                            var worldPxX = this.mapMeta.worldPxLeft + px;
                            var worldPxY = this.mapMeta.worldPxTop + py;
                            var world = this.worldPxToWorldXZ(worldPxX, worldPxY);
                            x = world.x;
                            z = world.z;
                        }
                        var clamped = this.clampWorldPointToMap(x, z, 22);
                        x = clamped.x;
                        z = clamped.z;

                        var id = "JNC-" + this.pad(i + 1, 3);
                        var node = new ht.Node();
                        node.setName(id);
                        node.p3([x, 8, z]);
                        node.s3([16, 8, 16]);
                        node.s({
                            "shape3d": "sphere",
                            "shape3d.color": "#9bd9ff",
                            "shape3d.top.color": "#d4efff",
                            "shape3d.light": true,
                            "wf.visible": true,
                            "wf.color": "rgba(15, 68, 98, 0.85)"
                        });
                        node.a("kind", "junction");
                        node.a("junctionId", id);
                        this.worldDM.add(node);

                        var j = {
                            id: id,
                            x: x,
                            z: z,
                            lat: this.center.lat,
                            lng: this.center.lng,
                            node: node
                        };
                        this.syncJunctionLatLngFromWorld(j);
                        this.junctions.push(j);
                        this.junctionById[id] = j;
                    }
                },

                clearRoadJunctions: function () {
                    for (var i = 0; i < this.junctions.length; i++) {
                        if (this.junctions[i].node) this.worldDM.remove(this.junctions[i].node);
                    }
                    this.junctions = [];
                    this.junctionById = {};
                    this.clearJunctionRoadNetwork();
                },

                clampWorldPointToMap: function (x, z, margin) {
                    if (!this.mapMeta) return { x: x, z: z };
                    margin = margin || 0;
                    var halfW = (this.mapMeta.width * this.unitsPerPixel) / 2 - margin;
                    var halfH = (this.mapMeta.height * this.unitsPerPixel) / 2 - margin;
                    return {
                        x: this.clamp(x, -halfW, halfW),
                        z: this.clamp(z, -halfH, halfH)
                    };
                },

                promptImportAsset: function () {
                    var perms = this.rolePermissions[this.currentRole] || this.rolePermissions.Operator;
                    if (!perms.editLayout) {
                        this.status.textContent = "RBAC: current role cannot import assets";
                        return;
                    }
                    if (this.detailOpen) this.closeDetailView();
                    var formatRaw = window.prompt("3D import format? Type: obj or fbx", "obj");
                    if (formatRaw == null) return;
                    var format = String(formatRaw).trim().toLowerCase();
                    if (format !== "obj" && format !== "fbx") {
                        this.status.textContent = "Unsupported format. Use obj or fbx.";
                        return;
                    }

                    var shapeNameSeed = "asset_model_" + (this.assetCounter + 1);
                    var shapeName = window.prompt("Shape id used in scene (letters/numbers/_/-)", shapeNameSeed);
                    if (shapeName == null) return;
                    shapeName = shapeName.trim();
                    if (!shapeName) {
                        this.status.textContent = "Import canceled: shape id is required";
                        return;
                    }

                    if (format === "obj") {
                        var objUrl = window.prompt("OBJ file URL", "");
                        if (!objUrl) return;
                        var mtlUrl = window.prompt("MTL file URL (optional)", "") || "";
                        this.importObjAsset(shapeName, objUrl.trim(), mtlUrl.trim());
                        return;
                    }

                    var fbxUrl = window.prompt("FBX file URL", "");
                    if (!fbxUrl) return;
                    this.importFbxAsset(shapeName, fbxUrl.trim());
                },

                importObjAsset: function (shapeName, objUrl, mtlUrl) {
                    var self = this;
                    var asset = this.createImportedAssetNode(shapeName, "OBJ");
                    this.status.textContent = "Loading OBJ asset: " + shapeName;
                    try {
                        ht.Default.loadObj(objUrl, mtlUrl || null, {
                            shape3d: shapeName,
                            center: true,
                            cube: true,
                            finishFunc: function (modelMap, array, rawS3) {
                                self.completeImportedAsset(asset, shapeName, rawS3, "OBJ");
                            }
                        });
                    }
                    catch (err) {
                        this.status.textContent = "OBJ import failed: " + (err && err.message ? err.message : String(err));
                        return;
                    }
                    this.fallbackCompleteImportedAsset(asset, shapeName, "OBJ");
                },

                importFbxAsset: function (shapeName, fbxUrl) {
                    var self = this;
                    var asset = this.createImportedAssetNode(shapeName, "FBX");
                    this.status.textContent = "Loading FBX asset: " + shapeName;
                    try {
                        ht.Default.loadFbx(fbxUrl, {
                            shape3d: shapeName,
                            center: true,
                            cube: true,
                            finishFunc: function (modelMap, array, rawS3) {
                                self.completeImportedAsset(asset, shapeName, rawS3, "FBX");
                            }
                        });
                    }
                    catch (err) {
                        this.status.textContent = "FBX import failed: " + (err && err.message ? err.message : String(err));
                        return;
                    }
                    this.fallbackCompleteImportedAsset(asset, shapeName, "FBX");
                },

                fallbackCompleteImportedAsset: function (asset, shapeName, label) {
                    var self = this;
                    setTimeout(function () {
                        if (asset.ready) return;
                        self.completeImportedAsset(asset, shapeName, null, label);
                    }, 1200);
                },

                completeImportedAsset: function (asset, shapeName, rawS3, label) {
                    if (!asset || !asset.node) return;
                    asset.ready = true;
                    asset.shapeName = shapeName;
                    asset.node.s("shape3d", shapeName);
                    asset.node.s("shape3d.light", true);
                    asset.node.s("wf.visible", true);
                    asset.node.s("wf.color", "rgba(154, 222, 255, 0.8)");

                    var size = this.normalizeRawSize(rawS3);
                    if (size) {
                        var maxDim = Math.max(size[0], size[1], size[2], 1);
                        var target = 150;
                        var factor = target / maxDim;
                        asset.node.s3([
                            Math.max(20, size[0] * factor),
                            Math.max(20, size[1] * factor),
                            Math.max(20, size[2] * factor)
                        ]);
                    }

                    var p = asset.node.p3();
                    if (p) {
                        var s3 = asset.node.s3();
                        asset.node.p3([p[0], Math.max(20, (s3 && s3[1] ? s3[1] / 2 : 46)), p[2]]);
                    }
                    this.syncMovedImportedAssets();
                    this.world3d.invalidate();
                    this.status.textContent = label + " asset imported as " + shapeName + ". Drag it in Edit Mode.";
                },

                normalizeRawSize: function (rawS3) {
                    if (!rawS3) return null;
                    if (Object.prototype.toString.call(rawS3) === "[object Array]" && rawS3.length >= 3) {
                        return [Math.abs(rawS3[0]) || 1, Math.abs(rawS3[1]) || 1, Math.abs(rawS3[2]) || 1];
                    }
                    if (typeof rawS3 === "object") {
                        var x = rawS3.x != null ? rawS3.x : rawS3.width;
                        var y = rawS3.y != null ? rawS3.y : rawS3.height;
                        var z = rawS3.z != null ? rawS3.z : rawS3.depth;
                        if (x != null && y != null && z != null) {
                            return [Math.abs(x) || 1, Math.abs(y) || 1, Math.abs(z) || 1];
                        }
                    }
                    return null;
                },

                createImportedAssetNode: function (shapeName, label) {
                    this.assetCounter += 1;
                    var id = "AST-" + this.pad(this.assetCounter, 3);
                    var worldCenter = this.world3d && this.world3d.getCenter ? this.world3d.getCenter() : [0, 0, 0];
                    var clamped = this.clampWorldPointToMap(worldCenter[0], worldCenter[2], 40);
                    var node = new ht.Node();
                    node.setName(id + " Â· " + shapeName);
                    node.p3([clamped.x, 46, clamped.z]);
                    node.s3([96, 92, 96]);
                    node.s({
                        "shape3d": "box",
                        "shape3d.color": "rgba(182, 216, 236, 0.9)",
                        "shape3d.top.color": "rgba(215, 236, 251, 0.96)",
                        "shape3d.light": true,
                        "wf.visible": true,
                        "wf.color": "rgba(34, 78, 112, 0.9)"
                    });
                    node.a("kind", "importedAsset");
                    node.a("assetId", id);
                    node.a("assetLabel", label || "Asset");
                    this.worldDM.add(node);
                    var asset = {
                        id: id,
                        label: label || "Asset",
                        shapeName: shapeName,
                        x: clamped.x,
                        z: clamped.z,
                        lat: this.center.lat,
                        lng: this.center.lng,
                        ready: false,
                        node: node
                    };
                    this.syncImportedAssetLatLngFromWorld(asset);
                    this.importedAssets.push(asset);
                    return asset;
                },

                bindWorldSelection: function () {
                    var self = this;
                    var sm = this.worldDM.getSelectionModel();
                    sm.setFilterFunc(function (data) {
                        if (!data || !data.a) return false;
                        var kind = data.a("kind");
                        return kind === "building" || kind === "buildingPart" || kind === "junction" || kind === "importedAsset";
                    });
                    sm.addSelectionChangeListener(function () {
                        var data = sm.getLastData();
                        if (!data) {
                            return;
                        }
                        var kind = data.a("kind");
                        if (kind === "junction") {
                            self.status.textContent = (data.getName ? data.getName() : "Junction") + " selected";
                            return;
                        }
                        if (kind === "importedAsset") {
                            self.status.textContent = "Imported asset selected";
                            return;
                        }
                        var id = data.a("buildingId");
                        if (id) {
                            self.selectBuilding(id, !self.editMode && !self.roadDrawMode);
                        }
                    });
                },

                selectBuilding: function (id, openTransition) {
                    var b = this.byId[id];
                    if (!b) {
                        return;
                    }

                    this.selectedId = id;
                    var perms = this.rolePermissions[this.currentRole] || this.rolePermissions.Operator;
                    this.btnEnter.disabled = this.editMode || this.roadDrawMode || !perms.enterBuilding;

                    for (var i = 0; i < this.buildings.length; i++) {
                        var it = this.buildings[i];
                        var isSel = it.id === id;
                        var color = it.alarm ? this.blendColor(it.baseColor, "#d84a4a", 0.55) : it.baseColor;
                        it.node.s("shape3d.color", color);
                        it.node.s("wf.visible", isSel ? true : false);
                        it.node.s("wf.color", isSel ? "#ffe07a" : "#000000");
                        if (it.roofNode) {
                            it.roofNode.s("shape3d.color", this.brighten(color, 0.32));
                        }
                        if (it.wingNode) {
                            it.wingNode.s("shape3d.color", this.blendColor(color, "#dbe8f7", 0.24));
                        }
                        if (it.crownNode) {
                            it.crownNode.s("shape3d.color", isSel ? "#ffe07a" : this.blendColor(color, "#ffffff", 0.5));
                        }
                    }

                    this.updateSelectionPanel();
                    this.updateModeSwitcher();
                    if (openTransition && !this.detailOpen) {
                        this.openDetailView(id);
                    }
                },

                openDetailView: function (id) {
                    if (this.editMode) {
                        this.status.textContent = "Turn off Edit Mode before entering building view";
                        return;
                    }
                    if (this.roadDrawMode) {
                        this.status.textContent = "Save or stop Road Draw mode before entering building view";
                        return;
                    }
                    var b = this.byId[id || this.selectedId];
                    if (!b) {
                        return;
                    }
                    var perms = this.rolePermissions[this.currentRole] || this.rolePermissions.Operator;
                    if (!perms.enterBuilding) {
                        this.status.textContent = "RBAC: current role cannot open building detail view";
                        return;
                    }

                    this.selectedId = b.id;
                    this.detailOpen = true;
                    this.btnBack.style.display = "";
                    this.btnEnter.style.display = "none";
                    this.updateModeSwitcher();
                    this.hideDetailPopup();
                    this.detailPopupAnchor = null;

                    this.animateWorldFocus(b);
                    this.prepareDetailScene(b);

                    this.viewStack.classList.add("detail-mode");
                    var self = this;
                    setTimeout(function () {
                        self.detail3d.invalidate();
                        self.animateDetailIntro();
                        self.showDetailPopup(b, {
                            x: self.detailHost.clientWidth * 0.5,
                            y: self.detailHost.clientHeight * 0.62
                        });
                    }, 40);
                },

                closeDetailView: function () {
                    if (!this.detailOpen) {
                        this.animateToCityHome();
                        return;
                    }

                    this.detailOpen = false;
                    this.viewStack.classList.remove("detail-mode");
                    this.btnBack.style.display = "none";
                    this.btnEnter.style.display = "";
                    this.updateModeSwitcher();
                    this.hideDetailPopup();
                    this.detailPopupAnchor = null;
                    this.animateToCityHome();

                    var self = this;
                    setTimeout(function () {
                        self.world3d.invalidate();
                    }, 60);
                },

                animateWorldFocus: function (b) {
                    var h = b.displayHeight || this.energyToHeight(b.energy);
                    var targetCenter = [b.x, h * 0.45, b.z];
                    var targetEye = [b.x + 340, h + 300, b.z + 360];
                    this.animateCamera(this.world3d, targetEye, targetCenter, 420);
                },

                animateToCityHome: function () {
                    var extent = this.mapMeta ? Math.max(this.mapMeta.width * this.unitsPerPixel, this.mapMeta.height * this.unitsPerPixel) : 4800;
                    var dist = this.clamp(extent * 0.48, 1700, this.cameraMaxDistance - 80);
                    this.animateCamera(this.world3d, [0, dist * 0.78, dist], [0, 0, 0], 520);
                },

                prepareDetailScene: function (b) {
                    this.detailDM.clear();
                    this.detailDM.add(this.detailFloor);

                    var h = (b.displayHeight || this.energyToHeight(b.energy)) * 1.45;
                    var footX = (b.footX || b.foot) * 2.05;
                    var footZ = (b.footZ || b.foot) * 2.05;

                    var focus = new ht.Node();
                    focus.setName(b.id);
                    focus.p3([0, h / 2, 0]);
                    focus.s3([footX, h, footZ]);
                    focus.s({
                        "shape3d": "box",
                        "shape3d.color": b.alarm ? this.blendColor(b.baseColor, "#d84a4a", 0.5) : b.baseColor,
                        "shape3d.top.color": this.brighten(b.baseColor, 0.22),
                        "shape3d.light": true,
                        "wf.visible": true,
                        "wf.color": "#ffe07a"
                    });
                    focus.a("kind", "detailBuilding");
                    focus.a("buildingId", b.id);
                    this.detailDM.add(focus);
                    this.detailBuildingNode = focus;

                    var podium = new ht.Node();
                    var podiumH = Math.max(30, h * 0.24);
                    podium.p3([0, podiumH / 2, 0]);
                    podium.s3([footX * 1.22, podiumH, footZ * 1.22]);
                    podium.s({
                        "shape3d": "box",
                        "shape3d.color": this.blendColor(b.baseColor, "#dbe8f7", 0.35),
                        "shape3d.light": true
                    });
                    this.detailDM.add(podium);

                    var roof = new ht.Node();
                    roof.p3([0, h + 8, 0]);
                    roof.s3([footX * 0.86, 10, footZ * 0.86]);
                    roof.s({
                        "shape3d": "box",
                        "shape3d.color": this.brighten(b.baseColor, 0.34),
                        "shape3d.top.color": this.brighten(b.baseColor, 0.5),
                        "shape3d.light": true
                    });
                    this.detailDM.add(roof);

                    var mech = new ht.Node();
                    mech.p3([footX * 0.18, h + 19, -footZ * 0.12]);
                    mech.s3([Math.max(16, footX * 0.24), 10, Math.max(16, footZ * 0.24)]);
                    mech.s({
                        "shape3d": "box",
                        "shape3d.color": this.blendColor(b.baseColor, "#ffffff", 0.56),
                        "shape3d.light": true
                    });
                    this.detailDM.add(mech);

                    var halo = new ht.Node();
                    halo.p3([0, h + 16, 0]);
                    halo.s3([footX * 1.08, 6, footZ * 1.08]);
                    halo.s({
                        "shape3d": "box",
                        "shape3d.color": "rgba(255, 224, 122, 0.65)",
                        "shape3d.transparent": true,
                        "shape3d.light": false
                    });
                    this.detailDM.add(halo);
                },

                animateDetailIntro: function () {
                    this.detail3d.setEye([760, 520, 760]);
                    this.detail3d.setCenter([0, 130, 0]);
                    this.animateCamera(this.detail3d, [260, 230, 300], [0, 130, 0], 620);
                },

                animateCamera: function (g3d, targetEye, targetCenter, duration) {
                    var fromEye = g3d.getEye();
                    var fromCenter = g3d.getCenter();
                    var start = performance.now();

                    function ease(t) {
                        return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
                    }

                    function step(now) {
                        var p = (now - start) / duration;
                        if (p > 1) p = 1;
                        var e = ease(p);

                        g3d.setEye([
                            fromEye[0] + (targetEye[0] - fromEye[0]) * e,
                            fromEye[1] + (targetEye[1] - fromEye[1]) * e,
                            fromEye[2] + (targetEye[2] - fromEye[2]) * e
                        ]);
                        g3d.setCenter([
                            fromCenter[0] + (targetCenter[0] - fromCenter[0]) * e,
                            fromCenter[1] + (targetCenter[1] - fromCenter[1]) * e,
                            fromCenter[2] + (targetCenter[2] - fromCenter[2]) * e
                        ]);

                        if (p < 1) {
                            requestAnimationFrame(step);
                        }
                    }

                    requestAnimationFrame(step);
                },

                startTelemetry: function () {
                    var self = this;
                    this.telemetryTimer = setInterval(function () {
                        self.tickBuildings();
                        self.updateDashboard();
                    }, 2200);
                },

                tickBuildings: function () {
                    if (this.editMode) {
                        this.syncMovedBuildings(false);
                        this.syncMovedJunctions(false);
                        this.syncMovedImportedAssets();
                    }
                    var i;
                    for (i = 0; i < this.buildings.length; i++) {
                        var b = this.buildings[i];
                        b.energy = this.clamp(b.energy + this.randInt(-14, 14), 24, 260);
                        b.occupancy = this.clamp(b.occupancy + this.randInt(-7, 7), 6, 100);
                        b.alarm = (b.energy > 228 || b.occupancy > 91) ? Math.random() > 0.35 : Math.random() < 0.07;
                        if (this.animateBuildingHeights) {
                            b.displayHeight = this.energyToHeight(b.energy);
                        }
                        this.updateBuildingGeometry(b);
                    }

                    if (this.selectedId) {
                        var selected = this.byId[this.selectedId];
                        if (selected && this.detailOpen) {
                            this.prepareDetailScene(selected);
                        }
                        this.selectBuilding(this.selectedId, false);
                    }
                },

                buildDistrictBars: function () {
                    var districts = ["North", "East", "Central", "South"];
                    var i;
                    this.districtBars.innerHTML = "";
                    for (i = 0; i < districts.length; i++) {
                        var d = districts[i];
                        var row = document.createElement("div");
                        row.className = "bar-row";
                        row.innerHTML =
                            '<div class="bar-head"><span>' + d + '</span><span id="district-val-' + d + '">0%</span></div>' +
                            '<div class="bar-track"><span class="bar-fill" id="district-fill-' + d + '"></span></div>';
                        this.districtBars.appendChild(row);

                        this.districtBarEls[d] = {
                            val: document.getElementById("district-val-" + d),
                            fill: document.getElementById("district-fill-" + d)
                        };
                    }
                },

                updateDashboard: function () {
                    var totalEnergy = 0;
                    var totalOcc = 0;
                    var alerts = 0;
                    var districtEnergy = { North: 0, East: 0, Central: 0, South: 0 };
                    var districtCount = { North: 0, East: 0, Central: 0, South: 0 };

                    var i;
                    for (i = 0; i < this.buildings.length; i++) {
                        var b = this.buildings[i];
                        totalEnergy += b.energy;
                        totalOcc += b.occupancy;
                        districtEnergy[b.district] += b.energy;
                        districtCount[b.district] += 1;
                        if (b.alarm || b.energy > 228 || b.occupancy > 91) alerts += 1;
                    }

                    this.kpiBuildings.textContent = String(this.buildings.length);
                    this.kpiLoad.textContent = (totalEnergy / 10).toFixed(1);
                    this.kpiOccupancy.textContent = (totalOcc / this.buildings.length).toFixed(0) + "%";
                    this.kpiAlerts.textContent = String(alerts);

                    var districts = ["North", "East", "Central", "South"];
                    for (i = 0; i < districts.length; i++) {
                        var d = districts[i];
                        var avg = districtCount[d] ? districtEnergy[d] / districtCount[d] : 0;
                        var pct = this.clamp(Math.round((avg / 260) * 100), 0, 100);
                        this.districtBarEls[d].val.textContent = pct + "%";
                        this.districtBarEls[d].fill.style.width = pct + "%";
                    }

                    this.updateAlerts();
                    this.updateSelectionPanel();
                },

                updateSelectionPanel: function () {
                    var b = this.selectedId ? this.byId[this.selectedId] : null;
                    if (!b) {
                        this.selectedName.textContent = "No building selected";
                        this.metaDistrict.textContent = "-";
                        this.metaType.textContent = "-";
                        this.metaEnergy.textContent = "-";
                        this.metaOccupancy.textContent = "-";
                        return;
                    }

                    this.selectedName.textContent = b.id;
                    this.metaDistrict.textContent = b.district;
                    this.metaType.textContent = b.type;
                    this.metaEnergy.textContent = b.energy + " kWh";
                    this.metaOccupancy.textContent = b.occupancy + "%";
                },

                updateAlerts: function () {
                    var top = this.buildings.slice().sort(function (a, b) {
                        return (b.occupancy + b.energy / 8 + (b.alarm ? 30 : 0)) -
                            (a.occupancy + a.energy / 8 + (a.alarm ? 30 : 0));
                    }).slice(0, 10);

                    if (this.alertList) this.alertList.innerHTML = "";
                    if (this.alertListContrast) this.alertListContrast.innerHTML = "";
                    if (this.leftAlertList) this.leftAlertList.innerHTML = "";
                    var critical = 0;
                    var watch = 0;
                    var i;
                    for (i = 0; i < top.length; i++) {
                        var b = top[i];
                        var tags = [];
                        if (b.alarm) tags.push("sensor anomaly");
                        if (b.occupancy > 91) tags.push("high occupancy");
                        if (b.energy > 228) tags.push("energy spike");
                        if (!tags.length) tags.push("watch");

                        if (this.alertList) {
                            var li = document.createElement("li");
                            li.textContent = b.id + " - " + b.district + " - " + tags.join(", ");
                            this.alertList.appendChild(li);
                        }

                        var severity = (b.alarm || b.occupancy > 94 || b.energy > 238) ? "critical" : "watch";
                        if (severity === "critical") critical += 1;
                        else watch += 1;

                        if (this.alertListContrast) {
                            var li2 = document.createElement("li");
                            li2.className = "alert-item " + severity;
                            li2.innerHTML =
                                '<span class="alert-badge ' + severity + '">' + severity.toUpperCase() + '</span>' +
                                '<span class="alert-text">' + b.id + " - " + b.district + " - " + tags.join(", ") + "</span>";
                            this.alertListContrast.appendChild(li2);
                        }

                        if (this.leftAlertList) {
                            var li3 = document.createElement("li");
                            li3.className = "alert-rail-item " + severity;
                            li3.innerHTML =
                                '<span class="alert-rail-badge">' + severity.toUpperCase() + "</span>" +
                                "<span>" + b.id + " Â· " + b.district + " Â· " + tags.join(", ") + "</span>";
                            this.leftAlertList.appendChild(li3);
                        }
                    }
                    if (this.alertCriticalCount) this.alertCriticalCount.textContent = String(critical);
                    if (this.alertWatchCount) this.alertWatchCount.textContent = String(watch);
                },

                computeDistrict: function (x, z) {
                    if (x < 0 && z < 0) return "North";
                    if (x >= 0 && z < 0) return "East";
                    if (x < 0 && z >= 0) return "Central";
                    return "South";
                },

                energyToHeight: function (energy) {
                    return 34 + energy * 1.45;
                },

                brighten: function (hex, factor) {
                    return this.blendColor(hex, "#ffffff", factor);
                },

                blendColor: function (hexA, hexB, t) {
                    var a = this.hexToRgb(hexA);
                    var b = this.hexToRgb(hexB);
                    var r = Math.round(a.r + (b.r - a.r) * t);
                    var g = Math.round(a.g + (b.g - a.g) * t);
                    var b2 = Math.round(a.b + (b.b - a.b) * t);
                    return "rgb(" + r + "," + g + "," + b2 + ")";
                },

                hexToRgb: function (hex) {
                    var s = hex.replace("#", "");
                    if (s.length === 3) {
                        s = s[0] + s[0] + s[1] + s[1] + s[2] + s[2];
                    }
                    return {
                        r: parseInt(s.slice(0, 2), 16),
                        g: parseInt(s.slice(2, 4), 16),
                        b: parseInt(s.slice(4, 6), 16)
                    };
                },

                rand: function (min, max) {
                    return min + Math.random() * (max - min);
                },

                randInt: function (min, max) {
                    return Math.floor(this.rand(min, max + 1));
                },

                clamp: function (v, min, max) {
                    return Math.max(min, Math.min(max, v));
                },

                mod: function (v, n) {
                    return ((v % n) + n) % n;
                },

                pad: function (n, width) {
                    var s = String(n);
                    while (s.length < width) s = "0" + s;
                    return s;
                }
            };

            window.addEventListener("load", function () {
                try {
                    app.init();
                }
                catch (err) {
                    app.showBootError(err && err.message ? err.message : String(err));
                    if (window.console && console.error) console.error(err);
                }
            });
        })();
    </script>
</body>
</html>
